<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Book a Car â€” Silas Car Rentals</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    .search-filter {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 20px;
    }
    .search-filter input, .search-filter select {
      padding: 8px;
      border-radius: 6px;
      border: 1px solid #ccc;
      flex: 1;
    }
    .car-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill,minmax(250px,1fr));
      gap: 20px;
    }
    .car-card {
      border: 1px solid #ddd;
      border-radius: 12px;
      padding: 15px;
      background: #fff;
      text-align: center;
    }
    .car-card h3 { margin-bottom: 5px; }
    .car-card p { margin-bottom: 8px; }
    .btn-sm { font-size: 0.85rem; padding: 5px 10px; }
  </style>
</head>
<body class="dashboard-body">

  <header class="navbar">
    <div class="container nav-inner">
      <a href="dashboard.html" class="brand">
        <div class="brand-mark">SC</div>
        <span class="brand-name">Silas Rentals</span>
      </a>
      <div class="nav-actions">
        <button class="btn-sm btn-ghost" id="cart-btn">Cart (<span id="cart-count">0</span>)</button>
      </div>
    </div>
  </header>

  <main class="container section">
    <h1>Book Your Car ðŸš—</h1>

    <!-- Search & Filter -->
    <div class="search-filter">
      <input type="text" id="searchInput" placeholder="Search by name or brand...">
      <select id="priceFilter">
        <option value="">All Prices</option>
        <option value="low">Below â‚¦5,000/day</option>
        <option value="mid">â‚¦5,000 - â‚¦15,000/day</option>
        <option value="high">Above â‚¦15,000/day</option>
      </select>
    </div>

    <!-- Cars Grid -->
    <div id="car-grid" class="car-grid">
      <p class="meta">Loading cars...</p>
    </div>
  </main>

  <div class="toast" id="toast"></div>

  <script type="module">
    import { BASE_URL, ENDPOINTS, showToast } from './app.js';

    const grid = document.getElementById('car-grid');
    const searchInput = document.getElementById('searchInput');
    const priceFilter = document.getElementById('priceFilter');
    const cartCountEl = document.getElementById('cart-count');

    let allCars = [];
    const params = new URLSearchParams(window.location.search);
    const section = params.get('section');
    const token = localStorage.getItem('token');

    function updateCounts() {
      cartCountEl.textContent = (JSON.parse(localStorage.getItem('cart')) || []).length;
    }

    function saveToStorage(key, car) {
      let arr = JSON.parse(localStorage.getItem(key)) || [];
      if (!arr.find(c => c.id === car.id)) {
        arr.push(car);
        localStorage.setItem(key, JSON.stringify(arr));
        showToast(`${car.name} added to ${key}`);
        updateCounts();
      } else {
        showToast(`${car.name} is already in ${key}`);
      }
    }

    function rentNow(car) {
      if (!token) {
        localStorage.setItem('currentRental', JSON.stringify(car));
        window.location.href = 'login.html';
        return;
      }
      localStorage.setItem('currentRental', JSON.stringify(car));
      window.location.href = 'checkout.html';
    }

    function renderCars(cars) {
      if (cars.length === 0) {
        grid.innerHTML = `<p class="meta">No cars found.</p>`;
        return;
      }
      grid.innerHTML = cars.map(car => `
        <div class="car-card">
          <h3>${car.name}</h3>
          <p>Brand: ${car.brand}</p>
          <p>â‚¦${car.price.toLocaleString()}/day</p>
          <button class="btn btn-sm btn-primary" onclick='rentNow(${JSON.stringify(car).replace(/"/g, "&quot;")})'>Rent Now</button>
          <button class="btn btn-sm btn-outline" onclick='saveToStorage("cart", ${JSON.stringify(car).replace(/"/g, "&quot;")})'>Add to Cart</button>
          <button class="btn btn-sm btn-outline" onclick='saveToStorage("wishlist", ${JSON.stringify(car).replace(/"/g, "&quot;")})'>Add to Wishlist</button>
          <button class="btn btn-sm btn-outline" onclick='saveToStorage("savedCars", ${JSON.stringify(car).replace(/"/g, "&quot;")})'>Save</button>
        </div>
      `).join('');
    }

    window.saveToStorage = saveToStorage;
    window.rentNow = rentNow;

    function filterCars() {
      let filtered = allCars;
      const searchTerm = searchInput.value.toLowerCase();
      if (searchTerm) {
        filtered = filtered.filter(c => c.name.toLowerCase().includes(searchTerm) || c.brand.toLowerCase().includes(searchTerm));
      }
      const priceVal = priceFilter.value;
      if (priceVal) {
        filtered = filtered.filter(c => {
          if (priceVal === 'low') return c.price < 5000;
          if (priceVal === 'mid') return c.price >= 5000 && c.price <= 15000;
          if (priceVal === 'high') return c.price > 15000;
        });
      }
      renderCars(filtered);
    }

    searchInput.addEventListener('input', filterCars);
    priceFilter.addEventListener('change', filterCars);

    async function fetchCars() {
      try {
        let cars;
        if (section) {
          cars = JSON.parse(localStorage.getItem(section)) || [];
        } else {
          const res = await fetch(BASE_URL + ENDPOINTS.cars);
          if (!res.ok) throw new Error();
          cars = await res.json();
        }
        allCars = cars;
        filterCars();
      } catch {
        // Fallback sample cars
        allCars = [
          { id: 1, name: "Mercedes Benz 2025", brand: "Mercedes", price: 20000 },
          { id: 2, name: "Toyota Corolla 2023", brand: "Toyota", price: 8000 },
          { id: 3, name: "Honda Civic 2024", brand: "Honda", price: 10000 }
        ];
        filterCars();
      }
    }

    function checkCurrentRental() {
      const rental = JSON.parse(localStorage.getItem('currentRental'));
      if (rental) {
        showToast(`Pre-filled rental for ${rental.name}`);
        searchInput.value = rental.name;
        filterCars();
        localStorage.removeItem('currentRental');
      }
    }

    fetchCars().then(checkCurrentRental);
    updateCounts();
  </script>
</body>
</html>
