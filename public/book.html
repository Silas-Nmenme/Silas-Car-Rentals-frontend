<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Book a Car - Silas Car Rentals</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
<header class="navbar">
  <div class="container nav-inner">
    <a href="index.html" class="brand"><div class="brand-mark">SC</div><span>Silas Car Rentals</span></a>
    <button onclick="window.history.back()" class="btn btn-outline">← Back</button>
  </div>
</header>

<main class="section container">
  <h2>Book Your Car</h2>

  <!-- Car details -->
  <div id="car-details" style="margin-bottom:20px; padding:10px; border:1px solid #ccc; border-radius:8px;">
    <img id="car-image" src="" alt="Car" style="max-width:300px; border-radius:8px;">
    <h3 id="car-title"></h3>
    <p id="car-price"></p>
  </div>

  <!-- Booking form -->
  <form id="booking-form">
    <label>Email</label>
    <input type="email" id="email" required>

    <label>Phone_Number</label>
    <input type="tel" id="phone_number" required>
    <label>Start Date</label>
    <input type="date" id="statDate" required>

    <label>End Date</label>
    <input type="date" id="endDate" required>

    <button type="submit" class="btn">Confirm Booking</button>
  </form>

  <div class="toast" id="toast"></div>
</main>

<script>
const API_BASE = "https://techyjaunt-auth-go43.onrender.com";
const placeholderImage = "https://vehicle-images.dealerinspire.com/a1a7-11002896/W1KAF4GB4SR252999/00f2d6ad30e089cb5c02791d58c3af6a.jpg";

let currentCar = JSON.parse(localStorage.getItem("currentCar")) || null;
let currentUser = JSON.parse(localStorage.getItem("user")) || null; // assuming you store logged in user here

function showToast(msg, ms=3000) {
  const toast = document.getElementById("toast");
  toast.textContent = msg;
  toast.classList.add("show");
  setTimeout(() => toast.classList.remove("show"), ms);
}

function renderCar(car) {
  document.getElementById("car-image").src = car.image || placeholderImage;
  document.getElementById("car-title").textContent = `${car.make} ${car.model}`;
  document.getElementById("car-price").textContent = `₦${car.price.toLocaleString()} / day`;
}

// Try updating car details from backend
async function fetchCarFromBackend() {
  if (!currentCar || !currentCar._id) return;
  try {
    const res = await fetch(`${API_BASE}/api/cars/get-cars`);
    if (!res.ok) throw new Error();
    const cars = await res.json();
    const car = cars.find(c => c._id === currentCar._id);
    if (car) {
      car.image = car.image && car.image.trim() !== "" ? car.image : placeholderImage;
      currentCar = car;
      localStorage.setItem("currentCar", JSON.stringify(car));
      renderCar(car);
    }
  } catch (err) {
    console.warn("Backend unavailable, using stored car data", err);
  }
}

// Booking form submit
document.getElementById("booking-form").addEventListener("submit", async e => {
  e.preventDefault();
  const token = localStorage.getItem("token");
  if (!token) {
    showToast("Please login first");
    setTimeout(() => window.location.href = "login.html", 1500);
    return;
  }

  if (!currentUser || !currentUser._id) {
    showToast("User information not found. Please log in again.");
    setTimeout(() => window.location.href = "login.html", 1500);
    return;
  }

  const bookingData = {
    carId: currentCar._id,
    email: document.getElementById("email").value,
    phone_number: document.getElementById("phone").value,
    startDate: document.getElementById("pickupDate").value,
    endDate: document.getElementById("returnDate").value,
    userId: currentUser._id // from stored logged in user
  };

  try {
    const res = await fetch(`${API_BASE}/api/bookings`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${token}`
      },
      body: JSON.stringify(bookingData)
    });

    const data = await res.json();
    if (!res.ok) throw new Error(data.message || "Booking failed");

    // Save booking for checkout
    const bookingToStore = {
      car: currentCar,
      pickupDate: bookingData.startDate,
      returnDate: bookingData.endDate,
      phoneNumber: bookingData.phone_number,
      email: bookingData.email
    };
    localStorage.setItem("lastBooking", JSON.stringify(bookingToStore));

    showToast("Booking confirmed!");
    setTimeout(() => window.location.href = "checkout.html", 1500);
  } catch (err) {
    showToast(err.message || "Booking error");
  }
});

// Init
if (currentCar) {
  renderCar(currentCar);
  fetchCarFromBackend();
} else {
  document.getElementById("car-details").innerHTML = "<p>No car selected. Please go back and choose one.</p>";
}
</script>
</body>
</html>
