<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Book a Car - Silas Car Rentals</title>
  <!-- Bootstrap CSS CDN -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Font Awesome CDN -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background-color: #f8f9fa;
    }
    
    .navbar {
      background: linear-gradient(135deg, #16a34a, #15803d) !important;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    
    .brand-mark {
      width: 40px;
      height: 40px;
      background: white;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .brand-name {
      color: white;
      font-weight: 700;
      font-size: 1.3rem;
    }
    
    .nav-link {
      color: rgba(255, 255, 255, 0.85) !important;
      font-weight: 500;
      transition: all 0.3s;
    }
    
    .nav-link:hover {
      color: white !important;
    }
    
    .btn-ghost {
      background: transparent;
      border: 1px solid rgba(255, 255, 255, 0.3);
      color: white;
    }
    
    .btn-ghost:hover {
      background: rgba(255, 255, 255, 0.1);
    }
    
    .booking-hero {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 4rem 0;
      text-align: center;
      margin-bottom: 2rem;
    }
    
    .booking-form {
      background: white;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
      padding: 2rem;
      margin: 2rem 0;
    }
    
    .form-control, .form-select {
      border: 1px solid #e1e5eb;
      border-radius: 10px;
      padding: 0.75rem 1rem;
      transition: all 0.3s;
    }
    
    .form-control:focus, .form-select:focus {
      border-color: #16a34a;
      box-shadow: 0 0 0 0.25rem rgba(22, 163, 74, 0.25);
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #16a34a, #15803d);
      border: none;
      border-radius: 10px;
      padding: 0.75rem 1.5rem;
      font-weight: 600;
      transition: all 0.3s;
    }
    
    .btn-primary:hover {
      background: linear-gradient(135deg, #15803d, #16a34a);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(22, 163, 74, 0.3);
    }
    
    .error-message {
      color: #dc3545;
      font-size: 0.875rem;
      margin-top: 0.25rem;
    }
    
    .car-selector {
      margin-bottom: 2rem;
      padding: 1.5rem;
      background: #f8f9fa;
      border-radius: 10px;
    }
    
    .selected-cars-display {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 1.5rem;
      margin-top: 1rem;
    }
    
    .car-id-box {
      background: white;
      border: 1px solid #e1e5eb;
      border-radius: 10px;
      padding: 1.5rem;
      text-align: center;
      box-shadow: 0 4px 6px rgba(0,0,0,0.05);
      transition: all 0.3s;
    }
    
    .car-id-box:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 15px rgba(0,0,0,0.1);
    }
    
    .footer {
      background: #1a1a1a;
      color: #fff;
      padding: 2rem 0;
      margin-top: 3rem;
    }
    
    @media (max-width: 768px) {
      .booking-hero {
        padding: 2rem 0;
      }
      
      .booking-form {
        padding: 1.5rem;
      }
      
      .selected-cars-display {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <!-- HEADER -->
  <header class="navbar navbar-expand-lg">
    <div class="container">
      <a href="index.html" class="navbar-brand d-flex align-items-center">
        <div class="brand-mark me-2">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M19 17H21C21.5523 17 22 17.4477 22 18V20C22 20.5523 21.5523 21 21 21H19C19 19.3431 17.6569 18 16 18C14.3431 18 13 19.3431 13 21H11C11 19.3431 9.65685 18 8 18C6.34315 18 5 19.3431 5 21H3C2.44772 21 2 20.5523 2 20V18C2 17.4477 2.44772 17 3 17H5C5 15.3431 6.34315 14 8 14C9.65685 14 11 15.3431 11 17H13C13 15.3431 14.3431 14 16 14C17.6569 14 19 15.3431 19 17Z" fill="currentColor"/>
            <path d="M16 8C16 6.34315 14.6569 5 13 5H11C9.34315 5 8 6.34315 8 8H6C4.34315 8 3 9.34315 3 11V13C3 14.6569 4.34315 16 6 16H18C19.6569 16 21 14.6569 21 13V11C21 9.34315 19.6569 8 18 8H16Z" fill="currentColor"/>
          </svg>
        </div>
        <span class="brand-name">Silas Car Rentals</span>
      </a>
      
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav me-auto">
          <li class="nav-item">
            <a href="index.html" class="nav-link">Home</a>
          </li>
          <li class="nav-item">
            <a href="cars.html" class="nav-link">Browse Cars</a>
          </li>
          <li class="nav-item">
            <a href="about.html" class="nav-link">About</a>
          </li>
          <li class="nav-item">
            <a href="contact.html" class="nav-link">Contact</a>
          </li>
        </ul>
        
        <div class="d-flex">
          <button class="btn btn-sm btn-ghost me-2" onclick="window.location.href='cart.html'" style="position: relative;">
            <i class="fas fa-shopping-cart me-1"></i>
            <span class="d-none d-sm-inline">Cart</span>
            <span class="visually-hidden">View Cart</span>
            <span id="cart-count" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">0</span>
          </button>
          <button class="btn btn-sm btn-primary" onclick="window.location.href='dashboard.html'">
            <i class="fas fa-user me-1"></i>
            <span class="d-none d-sm-inline">My Account</span>
            <span class="visually-hidden">Access My Account</span>
          </button>
        </div>
      </div>
    </div>
  </header>

  <!-- HERO SECTION -->
  <section class="booking-hero">
    <div class="container">
      <h1>Book Your Perfect Car</h1>
      <p>Simple and quick booking process</p>
    </div>
  </section>

  <!-- MAIN CONTENT -->
  <main class="container section">
    <form class="booking-form" id="bookingForm">
      <h2 class="mb-4">Booking Details</h2>
      
      <!-- Hidden carId field -->
      <input type="hidden" id="carId" name="carId" />
      
      <!-- Car Selection -->
      <div class="car-selector mb-4" id="car-selector">
        <label for="car-select" class="form-label">Select a Car:</label>
        <select id="car-select" name="car-select" class="form-select" required>
          <option value="">-- Select a car --</option>
        </select>
        <div id="selected-cars" class="selected-cars-display mt-3"></div>
      </div>
      
      <!-- Contact Information -->
      <div class="mb-3">
        <label for="email" class="form-label">Email Address *</label>
        <input type="email" id="email" name="email" class="form-control" required placeholder="your.email@example.com" />
        <div class="error-message" id="email-error"></div>
      </div>
      
      <div class="mb-3">
        <label for="phone" class="form-label">Phone Number *</label>
        <input type="tel" id="phone" name="phone_number" class="form-control" required placeholder="+2348012345678" />
        <div class="error-message" id="phone-error"></div>
      </div>
      
      <!-- Booking Details -->
      <div class="row">
        <div class="col-md-6 mb-3">
          <label for="pickup-date" class="form-label">Pickup Date *</label>
          <input type="date" id="pickup-date" name="pickup_date" class="form-control" required />
          <div class="error-message" id="pickup-date-error"></div>
        </div>
        <div class="col-md-6 mb-3">
          <label for="return-date" class="form-label">Return Date *</label>
          <input type="date" id="return-date" name="return_date" class="form-control" required />
          <div class="error-message" id="return-date-error"></div>
        </div>
      </div>
      
      <button type="submit" class="btn btn-primary btn-lg w-100" id="submitBtn">
        <span id="submit-text">Proceed to Payment</span>
        <span id="loading-text" style="display: none;">Processing...</span>
      </button>
      
      <div class="loading text-center mt-3" id="loading" style="display: none;">
        <p>Processing your booking...</p>
      </div>
    </form>
  </main>

  <!-- FOOTER -->
  <footer class="footer">
    <div class="container">
      <p>&copy; 2025 Silas Car Rentals. All rights reserved.</p>
    </div>
  </footer>

  <script src="booking-fix-enhanced.js"></script>
  <script>
const API_BASE = "https://techyjaunt-auth-go43.onrender.com";

document.addEventListener('DOMContentLoaded', function() {
  // Check login first - handle null/undefined localStorage values
  const userData = localStorage.getItem('user');
  let user = null;
  try {
    user = userData ? JSON.parse(userData) : null;
  } catch (e) {
    console.error('Error parsing user data:', e);
    user = null;
  }
  
  if (!user || !user.id) {
    alert('Please login first to continue with booking');
    window.location.href = 'login.html';
    return;
  }

  // Set minimum date to today
  const today = new Date().toISOString().split('T')[0];
  document.getElementById('pickup-date').min = today;
  document.getElementById('return-date').min = today;

  // Check if coming from cart
  const urlParams = new URLSearchParams(window.location.search);
  const fromCart = urlParams.get('fromCart') === 'true';
  
  // Load cars based on source
  if (fromCart) {
    loadCarsFromCart();
  } else {
    loadCarsFromCartAndAPI();
  }

  // Pre-fill user info
  document.getElementById('email').value = user.email || '';
  document.getElementById('phone').value = user.phone || '';

  // Auto-set return date to 1 day after pickup
  document.getElementById('pickup-date').addEventListener('change', function() {
    const returnDate = document.getElementById('return-date');
    const pickup = new Date(this.value);
    const nextDay = new Date(pickup);
    nextDay.setDate(nextDay.getDate() + 1);
    returnDate.min = this.value;
    if (!returnDate.value || new Date(returnDate.value) <= pickup) {
      returnDate.value = nextDay.toISOString().split('T')[0];
    }
  });

  // Form submission
  document.getElementById('bookingForm').addEventListener('submit', function(e) {
    e.preventDefault();

    // Clear previous errors
    document.querySelectorAll('.error-message').forEach(el => el.textContent = '');

    // Validate form
    let isValid = true;

    const email = document.getElementById('email').value.trim();
    const phone = document.getElementById('phone').value.trim();
    const startDate = document.getElementById('pickup-date').value;
    const endDate = document.getElementById('return-date').value;
    const carId = document.getElementById('carId').value;

    if (!carId) {
      alert('Please select a car from your cart or choose one from the available options.');
      isValid = false;
    }
    if (!email) {
      document.getElementById('email-error').textContent = 'Email is required';
      isValid = false;
    } else if (!isValidEmail(email)) {
      document.getElementById('email-error').textContent = 'Please enter a valid email address';
      isValid = false;
    }
    if (!phone) {
      document.getElementById('phone-error').textContent = 'Phone number is required';
      isValid = false;
    }
    if (!startDate) {
      document.getElementById('pickup-date-error').textContent = 'Pickup date is required';
      isValid = false;
    }
    if (!endDate) {
      document.getElementById('return-date-error').textContent = 'Return date is required';
      isValid = false;
    }
    if (startDate && endDate && new Date(endDate) <= new Date(startDate)) {
      document.getElementById('return-date-error').textContent = 'Return date must be after pickup date';
      isValid = false;
    }
    if (!isValid) return;

    // Show loading state
    const submitBtn = document.getElementById('submitBtn');
    const originalText = submitBtn.querySelector('#submit-text').textContent;
    submitBtn.disabled = true;
    submitBtn.querySelector('#submit-text').textContent = 'Processing...';

    try {
      // Get car details from cart or selected option
      let carDetails;
      const cartItems = JSON.parse(localStorage.getItem('cart') || '[]');
      const cartCar = cartItems.find(c => c._id === carId);
      
      if (cartCar) {
        carDetails = cartCar;
      } else {
        // Get from selected dropdown
        const carSelect = document.getElementById('car-select');
        const selectedOption = carSelect.options[carSelect.selectedIndex];
        carDetails = {
          _id: carId,
          make: selectedOption.dataset.make,
          model: selectedOption.dataset.model,
          year: selectedOption.dataset.year,
          price: parseInt(selectedOption.dataset.price),
          image: selectedOption.dataset.image
        };
      }

      const bookingData = {
        userId: user.id,
        car: carDetails,
        pickupDate: startDate,
        returnDate: endDate,
        phoneNumber: phone,
        email: email,
        source: 'book'
      };

      const booking = setBooking(bookingData);
      
      if (booking) {
        // Redirect to checkout page
        window.location.href = 'checkout.html';
      } else {
        throw new Error('Failed to create booking. Please try again.');
      }
    } catch (error) {
      console.error('Booking error:', error);
      alert(error.message || 'Failed to create booking. Please try again.');
    } finally {
      // Reset button state
      submitBtn.disabled = false;
      submitBtn.querySelector('#submit-text').textContent = originalText;
    }
  });
});

// Function to validate email
function isValidEmail(email) {
  const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  return re.test(String(email).toLowerCase());
}

// Enhanced function: load cars from cart and API
async function loadCarsFromCartAndAPI() {
  const carSelect = document.getElementById('car-select');
  carSelect.innerHTML = '<option value="">-- Select a car --</option>';
  
  try {
    // Get cart items first
    const cartItems = JSON.parse(localStorage.getItem('cart') || '[]');
    
    // Load cars from API
    const res = await fetch(`${API_BASE}/api/cars`);
    if (!res.ok) throw new Error('Failed to fetch cars');
    const apiCars = await res.json();
    
    // Create combined list: prioritize cart items
    let allCars = [...cartItems];

    // Add API cars, excluding duplicates
    apiCars.forEach(car => {
      if (!allCars.some(item => item._id === car._id)) {
        allCars.push(car);
      }
    });
    
    // Populate dropdown
    allCars.forEach(car => {
      const opt = document.createElement('option');
      opt.value = car._id;
      opt.textContent = `${car.make} ${car.model} (${car.year}) - â‚¦${car.price.toLocaleString()}/day`;
      opt.dataset.make = car.make;
      opt.dataset.model = car.model;
      opt.dataset.year = car.year;
      opt.dataset.price = car.price;
      opt.dataset.image = car.image || '';
      carSelect.appendChild(opt);
    });
    
    // Auto-select first cart item if available
    if (cartItems.length > 0) {
      const firstCartCar = carSelect.querySelector(`option[value="${cartItems[0]._id}"]`);
      if (firstCartCar) {
        firstCartCar.selected = true;
        document.getElementById('carId').value = cartItems[0]._id;
      }
    }
    
  } catch (err) {
    console.error('Error loading cars:', err);
    carSelect.innerHTML = '<option value="">Unable to load cars</option>';
  }
}

// Function to load cars specifically from cart
function loadCarsFromCart() {
  const carSelect = document.getElementById('car-select');
  const selectedCarsContainer = document.getElementById('selected-cars');
  carSelect.innerHTML = '<option value="">-- Select a car --</option>';
  selectedCarsContainer.innerHTML = '';
  
  try {
    // Get cart items
    const cartItems = JSON.parse(localStorage.getItem('cart') || '[]');
    
    if (cartItems.length === 0) {
      // If no items in cart, show message and redirect
      const noItemsMessage = document.createElement('div');
      noItemsMessage.style.cssText = 'background: #fff3cd; border: 1px solid #ffeaa7; padding: 1rem; border-radius: 8px; margin: 1rem 0; text-align: center;';
      noItemsMessage.innerHTML = `
        <strong>ðŸ›’ Your cart is empty!</strong>
        <p>No cars found in your cart. Please add cars to your cart first.</p>
        <button onclick="window.location.href='cars.html'" class="btn btn-primary" style="margin-top: 0.5rem;">
          Browse Cars
        </button>
      `;
      
      const carSelector = document.querySelector('.car-selector');
      if (carSelector) {
        carSelector.innerHTML = '';
        carSelector.appendChild(noItemsMessage);
      }
      return;
    }
    
    // Display cart items in the selected cars container
    cartItems.forEach(car => {
      const carBox = document.createElement('div');
      carBox.className = 'car-id-box';
      carBox.innerHTML = `
        <h4>${car.make} ${car.model}</h4>
        <p>${car.year} â€¢ â‚¦${car.price.toLocaleString()}/day</p>
        <button onclick="selectCarFromCart('${car._id}')" class="btn btn-primary btn-sm" style="margin-top: 0.5rem;">
          Select This Car
        </button>
      `;
      selectedCarsContainer.appendChild(carBox);
    });
    
    // Also populate dropdown with cart items
    cartItems.forEach(car => {
      const opt = document.createElement('option');
      opt.value = car._id;
      opt.textContent = `${car.make} ${car.model} (${car.year}) - â‚¦${car.price.toLocaleString()}/day [From Cart]`;
      opt.dataset.make = car.make;
      opt.dataset.model = car.model;
      opt.dataset.year = car.year;
      opt.dataset.price = car.price;
      opt.dataset.image = car.image || '';
      carSelect.appendChild(opt);
    });
    
    // Auto-select first cart item
    if (cartItems.length > 0) {
      const firstCartCar = carSelect.querySelector(`option[value="${cartItems[0]._id}"]`);
      if (firstCartCar) {
        firstCartCar.selected = true;
        document.getElementById('carId').value = cartItems[0]._id;
      }
    }
    
  } catch (err) {
    console.error('Error loading cart cars:', err);
    carSelect.innerHTML = '<option value="">Unable to load cart items</option>';
  }
}

// Function to select a car from cart display
function selectCarFromCart(carId) {
  document.getElementById('carId').value = carId;
  const carSelect = document.getElementById('car-select');
  const option = carSelect.querySelector(`option[value="${carId}"]`);
  if (option) {
    option.selected = true;
  }
  alert('Car selected! Click "Proceed to Payment" to continue.');
}
  </script>
</body>
</html>
