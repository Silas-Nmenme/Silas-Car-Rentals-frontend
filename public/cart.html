<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>My Cart - Silas Car Rentals</title>
  <link rel="stylesheet" href="style.css" />
  <script src="cart-fix.js"></script>
  <script src="booking-fix-enhanced.js"></script>
</head>
<body>
<header class="navbar">
  <div class="container nav-inner">
    <a href="index.html" class="brand">
      <div class="brand-mark">SC</div>
      <span class="brand-name">Silas Car Rentals</span>
    </a>
    <nav class="nav-links">
      <a class="nav-link" href="index.html#browse">Browse</a>
      <a class="nav-link" href="book.html">Book</a>
    </nav>
    <div class="nav-actions">
      <button class="btn btn-ghost" onclick="location.href='cart.html'">üßæ Cart (<span id="cart-count">0</span>)</button>
      <button class="btn btn-ghost" onclick="location.href='wishlist.html'">‚ù§Ô∏è Wishlist (<span id="wishlist-count">0</span>)</button>
      <button class="btn btn-ghost" onclick="location.href='saved.html'">üíæ Saved (<span id="saved-count">0</span>)</button>
    </div>
  </div>
</header>

<main class="section container">
  <h1>My Booking Cart</h1>
  <div style="display: flex; gap: 1rem; margin-bottom: 1rem; flex-wrap: wrap;">
    <button class="btn btn-outline" onclick="CartManager.clear()">Clear Cart</button>
    <button class="btn" onclick="window.location.href='cars.html'">Continue Shopping</button>
  </div>
  <div id="cart-items" class="grid" style="gap:20px; margin-top:20px;"></div>
  
  <!-- Cart Summary -->
  <div id="cart-summary" style="margin-top: 2rem; padding: 1.5rem; background: #1f1f1f; border-radius: 8px; display: none;">
    <h3>Cart Summary</h3>
    <div style="display: flex; justify-content: space-between; align-items: center; margin: 1rem 0;">
      <span>Total Items:</span>
      <span id="cart-total-items">0</span>
    </div>
    <div style="display: flex; justify-content: space-between; align-items: center; margin: 1rem 0;">
      <span>Estimated Total:</span>
      <span id="cart-total-price">‚Ç¶0</span>
    </div>
    <button class="btn" style="width: 100%; margin-top: 1rem;" onclick="handleCartCheckout()">
      Proceed to Checkout
    </button>
  </div>
</main>

<div class="toast" id="toast"></div>

<script>
// Enhanced cart page functionality
document.addEventListener('DOMContentLoaded', function() {
    // Update cart summary
    function updateCartSummary() {
        const cart = CartManager.getItems();
        const summary = document.getElementById('cart-summary');
        const totalItems = document.getElementById('cart-total-items');
        const totalPrice = document.getElementById('cart-total-price');
        
        if (cart.length > 0) {
            summary.style.display = 'block';
            totalItems.textContent = cart.length;
            
            const total = cart.reduce((sum, car) => sum + (car.price || 0), 0);
            totalPrice.textContent = `‚Ç¶${total.toLocaleString()}`;
        } else {
            summary.style.display = 'none';
        }
    }
    
    // Handle checkout from cart
    function handleCartCheckout() {
        const cart = CartManager.getItems();
        if (cart.length === 0) {
            BookingManager.showError('Your cart is empty. Please add a car first.');
            return;
        }
        
        try {
            // Store all cart items for booking page
            const bookingData = {
                cars: cart,
                source: 'cart'
            };
            
            const booking = BookingManager.setBooking(bookingData);
            
            if (booking) {
                console.log("Multi-car booking created:", booking);
                
                // Verify booking is stored correctly
                const storedBooking = BookingManager.getBooking();
                if (!storedBooking || !storedBooking.cars || storedBooking.cars.length === 0) {
                    throw new Error('Failed to create multi-car booking. Please try again.');
                }
                
                // Redirect to book.html to collect booking details
                window.location.href = 'book.html?fromCart=true';
            } else {
                throw new Error('Failed to create booking. Please try again.');
            }
        } catch (error) {
            console.error('Cart checkout error:', error);
            BookingManager.showError(error.message || 'Failed to proceed to checkout. Please try again.');
        }
    }
    
    // Handle Book Now button click
    function handleBookNow(carId) {
        const token = localStorage.getItem("authToken");
        if (!token) {
            showToast("Please login first", 3000, "#f44336");
            setTimeout(() => (window.location.href = "login.html"), 1200);
            return;
        }
        // Redirect to book.html with the selected car ID
        window.location.href = `book.html?carId=${carId}`;
    }

    // Override renderCart for cart page
    window.renderCart = function() {
        const cart = CartManager.getItems();
        const container = document.getElementById('cart-items');
        
        if (!cart.length) {
            container.innerHTML = `
                <div style="text-align: center; padding: 3rem;">
                    <h3>Your cart is empty</h3>
                    <p style="margin: 1rem 0; color: var(--muted);">Start adding cars to your cart to see them here.</p>
                    <button class="btn" onclick="window.location.href='cars.html'">Browse Cars</button>
                </div>
            `;
            return;
        }
        
        container.innerHTML = cart.map((car, index) => `
            <div class="car-card" data-car-id="${car._id}">
                <img src="${car.image}" alt="${car.make} ${car.model}" loading="lazy" style="width:100%; height:200px; object-fit:cover; border-radius:8px;">
                <div style="padding: 1rem;">
                    <h3>${car.make} ${car.model}</h3>
                    <p style="color: var(--muted);">${car.year} ‚Ä¢ ${car.color}</p>
                    <p style="font-size: 1.2rem; font-weight: bold; color: var(--primary);">
                        ‚Ç¶${car.price.toLocaleString()}/day
                    </p>
                    <p style="font-size: 0.9rem; color: var(--muted); margin: 0.5rem 0;">
                        ${car.description}
                    </p>
                    <div style="display: flex; gap: 8px; flex-wrap: wrap; margin-top: 1rem;">
<button class="btn" onclick="handleBookNow('${car._id}')">
                            Book Now
                        </button>
                        <button class="btn btn-outline" onclick="CartManager.remove('${car._id}')">
                            Remove
                        </button>
                    </div>
                </div>
            </div>
        `).join('');
    }
    
    // Initialize cart display
    updateCartSummary();
    window.renderCart();
    
    // Update checkout button handler
    const checkoutBtn = document.querySelector('#cart-summary button');
    if (checkoutBtn) {
        checkoutBtn.onclick = handleCartCheckout;
    }
});
</script>
</body>
</html>
