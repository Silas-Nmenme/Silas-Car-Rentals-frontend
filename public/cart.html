<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>My Cart - Silas Car Rentals</title>
  <link rel="stylesheet" href="style.css" />
  <script src="cart-fix.js"></script>
  <script src="booking-fix-enhanced.js"></script>
</head>
<body>
<header class="navbar">
  <div class="container nav-inner">
    <a href="index.html" class="brand">
      <div class="brand-mark">SC</div>
      <span class="brand-name">Silas Car Rentals</span>
    </a>
    <nav class="nav-links">
      <a class="nav-link" href="index.html#browse">Browse</a>
      <a class="nav-link" href="book.html">Book</a>
    </nav>
    <div class="nav-actions">
      <button class="btn btn-ghost" onclick="location.href='cart.html'">üßæ Cart (<span id="cart-count">0</span>)</button>
      <button class="btn btn-ghost" onclick="location.href='wishlist.html'">‚ù§Ô∏è Wishlist (<span id="wishlist-count">0</span>)</button>
      <button class="btn btn-ghost" onclick="location.href='saved.html'">üíæ Saved (<span id="saved-count">0</span>)</button>
    </div>
  </div>
</header>

<main class="section container">
  <h1>My Booking Cart</h1>
  <div style="display: flex; gap: 1rem; margin-bottom: 1rem; flex-wrap: wrap;">
    <button class="btn btn-outline" onclick="CartManager.clear()">Clear Cart</button>
    <button class="btn" onclick="window.location.href='cars.html'">Continue Shopping</button>
  </div>
  <div id="cart-items" class="grid" style="gap:20px; margin-top:20px;"></div>
  
  <!-- Cart Summary -->
  <div id="cart-summary" style="margin-top: 2rem; padding: 1.5rem; background: #1f1f1f; border-radius: 8px; display: none;">
    <h3>Cart Summary</h3>
    <div style="display: flex; justify-content: space-between; align-items: center; margin: 1rem 0;">
      <span>Total Items:</span>
      <span id="cart-total-items">0</span>
    </div>
    <div style="display: flex; justify-content: space-between; align-items: center; margin: 1rem 0;">
      <span>Estimated Total:</span>
      <span id="cart-total-price">‚Ç¶0</span>
    </div>
    <button class="btn" style="width: 100%; margin-top: 1rem;" id="cart-checkout-btn">
      Proceed to Checkout
    </button>
  </div>
</main>

<div class="toast" id="toast"></div>

<script>
// --- Auth helper (unifies everywhere) ---
function getCurrentUser() {
  // Preferred: a single 'user' JSON with { id, token, email, ... }
  try {
    const u = JSON.parse(localStorage.getItem('user') || 'null');
    if (u && (u.token || u.id)) return u;
  } catch {}
  // Back-compat for older pages:
  const legacyToken = localStorage.getItem('authToken') || localStorage.getItem('userToken') || localStorage.getItem('token');
  if (legacyToken) return { token: legacyToken };
  return null;
}

function showToast(msg, ms=2500) {
  const t = document.getElementById('toast');
  if (!t) return;
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'), ms);
}

// Enhanced cart page functionality
document.addEventListener('DOMContentLoaded', function() {
  function updateCartSummary() {
    const cart = CartManager.getItems();
    const summary = document.getElementById('cart-summary');
    const totalItems = document.getElementById('cart-total-items');
    const totalPrice = document.getElementById('cart-total-price');
    if (cart.length > 0) {
      summary.style.display = 'block';
      totalItems.textContent = cart.length;
      const total = cart.reduce((sum, car) => sum + (car.price || 0), 0);
      totalPrice.textContent = `‚Ç¶${total.toLocaleString()}`;
    } else {
      summary.style.display = 'none';
    }
  }

  // Proceed directly to checkout.html (not book.html)
  async function handleCartCheckout() {
    const user = getCurrentUser();
    if (!user || !user.token) {
      showToast('Please login to continue');
      setTimeout(()=>window.location.href='login.html', 900);
      return;
    }
    const cart = CartManager.getItems();
    if (!cart.length) {
      showToast('Your cart is empty.');
      return;
    }
    try {
      const bookingData = {
        isMultiCar: cart.length > 1,
        cars: cart,
        car: cart.length === 1 ? cart[0] : undefined,
        source: 'cart',
        // let checkout collect/confirm dates & contact if not already set
      };
      BookingManager.setBooking(bookingData);
      // also drop a compatible fallback for pages that don't load BookingManager in time
      sessionStorage.setItem('booking', JSON.stringify(bookingData));
      window.location.href = 'checkout.html';
    } catch (e) {
      console.error(e);
      showToast('Could not proceed to checkout.');
    }
  }

  window.renderCart = function() {
    const cart = CartManager.getItems();
    const container = document.getElementById('cart-items');
    if (!cart.length) {
      container.innerHTML = `
        <div style="text-align:center; padding:3rem;">
          <h3>Your cart is empty</h3>
          <p style="margin:1rem 0; color:var(--muted);">Start adding cars to your cart to see them here.</p>
          <button class="btn" onclick="window.location.href='cars.html'">Browse Cars</button>
        </div>
      `;
      return;
    }
    container.innerHTML = cart.map(car => `
      <div class="car-card" data-car-id="${car._id}">
        <img src="${car.image}" alt="${car.make} ${car.model}" loading="lazy" style="width:100%; height:200px; object-fit:cover; border-radius:8px;">
        <div style="padding: 1rem;">
          <h3>${car.make} ${car.model}</h3>
          <p style="color: var(--muted);">${car.year} ‚Ä¢ ${car.color}</p>
          <p style="font-size: 1.2rem; font-weight: bold; color: var(--primary);">‚Ç¶${car.price.toLocaleString()}/day</p>
          <p style="font-size:.9rem; color:var(--muted); margin:.5rem 0;">${car.description || ''}</p>
          <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:1rem;">
            <button class="btn" onclick="window.location.href='book.html?carId=${car._id}'">Book Now</button>
            <button class="btn btn-outline" onclick="CartManager.remove('${car._id}')">Remove</button>
          </div>
        </div>
      </div>
    `).join('');
  };

  updateCartSummary();
  window.renderCart();
  const checkoutBtn = document.getElementById('cart-checkout-btn');
  if (checkoutBtn) checkoutBtn.onclick = handleCartCheckout;
});
</script>
</body>
</html>
