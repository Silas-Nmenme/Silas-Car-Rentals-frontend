<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Google Sign-In - Processing...</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
      color: #e0e0e0;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      margin: 0;
    }
    .processing-container { text-align: center; padding: 2rem; }
    .spinner {
      border: 4px solid rgba(3, 218, 197, 0.3);
      border-top: 4px solid #03dac5;
      border-radius: 50%;
      width: 50px; height: 50px;
      animation: spin 1s linear infinite;
      margin: 0 auto 1rem;
    }
    @keyframes spin { 0%{transform:rotate(0)} 100%{transform:rotate(360deg)} }
    .error-message { color: #ff6b6b; margin-top: 1rem; font-size: 0.9rem; }
    .retry-btn {
      background: #03dac5; color: #121212;
      border: none; padding: 0.75rem 1.5rem;
      border-radius: 6px; cursor: pointer;
      font-weight: 600; margin-top: 1rem; transition: all 0.3s;
    }
    .retry-btn:hover { background: #00b2a9; transform: translateY(-1px); }
  </style>
</head>
<body>
  <div class="processing-container">
    <div class="spinner"></div>
    <h2>Processing Google Sign-In...</h2>
    <p>Please wait while we authenticate your account.</p>
    <div id="error-container" style="display: none;">
      <p class="error-message" id="error-message"></p>
      <button class="retry-btn" onclick="goBack()">Try Again</button>
    </div>
  </div>

  <script>
    window.addEventListener('DOMContentLoaded', () => {
      const urlParams = new URLSearchParams(window.location.search);
      const code = urlParams.get('code');
      const state = urlParams.get('state');
      const error = urlParams.get('error');
      const errorDescription = urlParams.get('error_description');

      if (error) {
        showError(errorDescription || decodeURIComponent(error));
        return;
      }

      if (code) {
        handleRedirectSuccess(code, state);
      } else {
        showError('No authorization code received from Google');
      }
    });

    async function handleRedirectSuccess(code, state) {
      try {
        document.querySelector('.processing-container').innerHTML = `
          <div class="spinner"></div>
          <h2>Completing Google Sign-In...</h2>
          <p>Please wait while we authenticate your account.</p>
        `;

        const baseUrl = "https://techyjaunt-auth-go43.onrender.com";
        const response = await fetch(`${baseUrl}/api/users/google/callback`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          credentials: "include",
          body: JSON.stringify({ code, state })
        });

        const data = await response.json();
        if (!response.ok) throw new Error(data.message || `Authentication failed: ${response.status}`);
        if (!data.token || !data.user) throw new Error("Invalid response from server");

        storeUserData(data);

        // âœ… Redirect new users to verify email
        if (data.user.isNew) {
          const tokenParam = data.user.verificationToken ? `?token=${data.user.verificationToken}` : "";
          window.location.href = `verify-email.html${tokenParam}`;
        } else {
          window.location.href = "dashboard.html";
        }
      } catch (error) {
        showError(error.message || "Authentication failed. Please try again.");
      }
    }

    function storeUserData(data) {
      try {
        const userObj = {
          id: data.user.id || data.user._id,
          email: data.user.email,
          name: data.user.name || "",
          role: data.user.role || "user",
          token: data.token
        };
        localStorage.setItem("user", JSON.stringify(userObj));
        localStorage.setItem("token", data.token); // backward compat
        console.log("User stored:", userObj);
      } catch (err) {
        console.error("Storage error:", err);
        throw new Error("Failed to store authentication data");
      }
    }

    function showError(message) {
      document.querySelector('.spinner').style.display = 'none';
      document.querySelector('h2').textContent = 'Authentication Failed';
      document.querySelector('p').textContent = 'We couldn\'t complete your Google sign-in.';
      document.getElementById('error-message').textContent = message;
      document.getElementById('error-container').style.display = 'block';
    }

    function goBack() {
      window.location.href = 'signup.html';
    }
  </script>
</body>
</html>
