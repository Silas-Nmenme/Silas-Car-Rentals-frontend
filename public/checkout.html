<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Booking Summary - Silas Car Rentals</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" />
  <style>
    .checkout-container{max-width:800px;margin:0 auto;padding:2rem 0}
    .summary-card{background:white;border-radius:15px;box-shadow:0 10px 30px rgba(0,0,0,.1);overflow:hidden;margin-bottom:2rem}
    .summary-header{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;padding:2rem;text-align:center}
    .summary-body{padding:2rem}
    .car-details{display:flex;gap:2rem;margin-bottom:2rem;padding-bottom:2rem;border-bottom:1px solid #eee}
    .car-image{width:200px;height:150px;object-fit:cover;border-radius:8px}
    .car-info h3{margin:0 0 .5rem 0;color:#333}
    .booking-details{display:grid;grid-template-columns:1fr 1fr;gap:1.5rem;margin-bottom:2rem}
    .detail-item{padding:1rem;background:#f8f9fa;border-radius:8px}
    .detail-item label{font-weight:600;color:#666;font-size:.875rem;text-transform:uppercase;letter-spacing:.5px}
    .detail-item p{margin:.5rem 0 0 0;font-size:1.125rem;color:#333}
    .price-breakdown{background:#f8f9fa;padding:1.5rem;border-radius:8px;margin-bottom:2rem}
    .price-row{display:flex;justify-content:space-between;margin-bottom:.5rem}
    .price-row.total{font-size:1.25rem;font-weight:bold;border-top:2px solid #ddd;padding-top:.5rem;margin-top:.5rem}
    .contact-info{background:#f8f9fa;padding:1.5rem;border-radius:8px;margin-bottom:2rem}
    .btn-group{display:flex;gap:1rem;justify-content:center}
    .btn-secondary{background:#6c757d;color:white}
    .btn-secondary:hover{background:#5a6268}
    .error-message{text-align:center;padding:2rem;color:#dc3545}
    @media (max-width:600px){
      .car-details{flex-direction:column}
      .car-image{width:100%;height:200px}
      .booking-details{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
<header class="navbar">
  <div class="container nav-inner">
    <a href="index.html" class="brand"><div class="brand-mark">SC</div><span>Silas Car Rentals</span></a>
    <button onclick="window.history.back()" class="btn btn-outline-secondary">← Back</button>
  </div>
</header>

<main class="section">
  <div class="checkout-container">
    <h1 class="text-center">Booking Summary</h1>
    <div id="checkout-content"></div>
    <div class="toast" id="toast"></div>
  </div>
</main>

<script src="booking-fix-enhanced.js"></script>
<script>
const API_BASE = "https://techyjaunt-auth-go43.onrender.com";
const placeholderImage = "https://images.unsplash.com/photo-1549317661-bd32c8ce0db2?auto=format&fit=crop&w=1000&q=80";

// ---------- Auth + utils ----------
function getCurrentUser(){
  try{
    const u = JSON.parse(localStorage.getItem('user')||'null');
    if(u && (u.token || u.id)) return u;
  }catch{}
  const legacyToken = localStorage.getItem('authToken') || localStorage.getItem('userToken') || localStorage.getItem('token');
  return legacyToken ? { token: legacyToken } : null;
}
function showToast(msg, ms=3000, bg="#03dac5"){
  const t=document.getElementById("toast"); if(!t) return;
  t.textContent=msg; t.style.background=bg; t.classList.add("show");
  setTimeout(()=>t.classList.remove("show"), ms);
}
function formatDate(d){ const date=new Date(d); return date.toLocaleDateString('en-US',{weekday:'long',year:'numeric',month:'long',day:'numeric'}) }
function getBookingSafe(){
  // Try manager first
  if (typeof BookingManager !== 'undefined' && BookingManager.getBooking) {
    const b = BookingManager.getBooking();
    if (b) return b;
  }
  // Fallbacks
  try {
    const b = JSON.parse(sessionStorage.getItem('booking') || sessionStorage.getItem('bookingSummary') || 'null');
    if (b) return b;
  } catch {}
  return null;
}
function calcDays(pickup, ret){
  const ms = (new Date(ret)) - (new Date(pickup));
  return Math.max(1, Math.ceil(ms / (1000*60*60*24)));
}

// ---------- Render ----------
function renderBooking(booking){
  const days = booking.days || (booking.pickupDate && booking.returnDate ? calcDays(booking.pickupDate, booking.returnDate) : 1);
  // compute total if missing
  let totalAmount = booking.totalAmount;
  if (!totalAmount) {
    if (booking.isMultiCar && booking.cars) {
      totalAmount = booking.cars.reduce((s,c)=> s + (Number(c.price)||0)*days, 0);
    } else if (booking.car) {
      totalAmount = (Number(booking.car.price)||0) * days;
    } else {
      totalAmount = 0;
    }
    booking.totalAmount = totalAmount;
  }

  let carContent='';
  if (booking.isMultiCar && Array.isArray(booking.cars)) {
    carContent = booking.cars.map(car => `
      <div class="car-details" style="margin-bottom:1.5rem;">
        <img src="${car.image || placeholderImage}" alt="${car.make||''} ${car.model||''}" loading="lazy" class="car-image">
        <div class="car-info">
          <h3>${car.make||''} ${car.model||''} (${car.year||''})</h3>
          <p style="color:#667eea;font-size:1.1rem;font-weight:bold;">₦${Number(car.price||0).toLocaleString()} per day</p>
          <p style="font-size:.9rem;color:#666;">${car.description || 'No description available'}</p>
        </div>
      </div>
    `).join('');
  } else if (booking.car) {
    const car = booking.car;
    carContent = `
      <div class="car-details">
        <img src="${car.image || placeholderImage}" alt="${car.make||''} ${car.model||''}" loading="lazy" class="car-image">
        <div class="car-info">
          <h3>${car.make||''} ${car.model||''} (${car.year||''})</h3>
          <p style="color:#667eea;font-size:1.25rem;font-weight:bold;">₦${Number(car.price||0).toLocaleString()} per day</p>
        </div>
      </div>
    `;
  }

  const prices = booking.isMultiCar && booking.cars ? booking.cars.map(car => `
      <div class="price-row">
        <span>${car.make||''} ${car.model||''} (${days} day${days>1?'s':''}):</span>
        <span>₦${(Number(car.price||0)*days).toLocaleString()}</span>
      </div>
  `).join('') : `
      <div class="price-row">
        <span>Car rental (${days} day${days>1?'s':''}):</span>
        <span>₦${(((booking.car?.price)||0)*days).toLocaleString()}</span>
      </div>
  `;

  const html = `
    <div class="summary-card">
      <div class="summary-header">
        <h2>Confirm Your Booking</h2>
        <p>Please review your booking details before proceeding to payment</p>
      </div>
      <div class="summary-body">
        ${carContent}
        <div class="booking-details">
          <div class="detail-item">
            <label>Pickup Date</label>
            <p>${booking.pickupDate ? formatDate(booking.pickupDate) : 'Not set'}</p>
          </div>
          <div class="detail-item">
            <label>Return Date</label>
            <p>${booking.returnDate ? formatDate(booking.returnDate) : 'Not set'}</p>
          </div>
          <div class="detail-item">
            <label>Duration</label>
            <p>${days} day${days>1?'s':''}</p>
          </div>
          <div class="detail-item">
            <label>Booking Type</label>
            <p>${booking.isMultiCar ? 'Multiple Cars' : 'Single Car'}</p>
          </div>
        </div>
        <div class="contact-info">
          <h4>Contact Information</h4>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;margin-top:1rem;">
            <div><label>Email</label><p>${booking.email || 'Not provided'}</p></div>
            <div><label>Phone</label><p>${booking.phoneNumber || 'Not provided'}</p></div>
          </div>
        </div>
        <div class="price-breakdown">
          <h4>Price Breakdown</h4>
          ${prices}
          <div class="price-row"><span>Service fee:</span><span>₦0</span></div>
          <div class="price-row"><span>Taxes:</span><span>₦0</span></div>
          <div class="price-row total"><span>Total Amount:</span><span>₦${Number(booking.totalAmount||0).toLocaleString()}</span></div>
        </div>
        <div class="btn-group">
          <button onclick="window.history.back()" class="btn btn-outline-secondary">← Back to Booking</button>
          <button id="pay-btn" class="btn btn-primary">Proceed to Payment</button>
          <button id="submit-booking-btn" class="btn btn-outline-secondary">Submit Booking Only</button>
        </div>
      </div>
    </div>
  `;
  document.getElementById('checkout-content').innerHTML = html;
}

// ---------- Submit booking to your API (re-uses BookingManager if present) ----------
async function submitBookingToBackend(){
  if (typeof BookingManager !== 'undefined' && BookingManager.submitBooking) {
    return BookingManager.submitBooking();
  }
  // If your BookingManager isn't available here, implement your fetch to /api/bookings ...
  return { success:false, error:'BookingManager not available' };
}

// ---------- Payment flow (matches /api/payments/pay/:carId) ----------
async function initiatePayment(){
  const user = getCurrentUser();
  if (!user) {
    showToast("Please login first", 3000, "#f44336");
    setTimeout(()=>window.location.href="login.html", 1200);
    return;
  }
  const booking = getBookingSafe();
  if (!booking) { showToast("No booking found.",3000,"#f44336"); return; }

  // Validate minimal fields
  if (!booking.pickupDate || !booking.returnDate) {
    showToast("Please select pickup and return dates.", 3000, "#f44336");
    return;
  }

  const payBtn = document.getElementById("pay-btn");
  const submitBtn = document.getElementById("submit-booking-btn");
  if (payBtn){ payBtn.disabled = true; payBtn.textContent = "Processing..."; }
  if (submitBtn){ submitBtn.disabled = true; }

  try {
    // 1) Ensure booking exists in backend (get bookingId)
    const bookingResult = await submitBookingToBackend();
    if (!bookingResult.success) throw new Error(bookingResult.error || "Failed to submit booking");
    const bookingId = bookingResult.data?._id || booking._id;
    booking._id = bookingId;

    // 2) Choose the carId for the route param — API expects a single :carId
    const carId = booking.isMultiCar ? booking.cars?.[0]?._id : booking.car?._id;
    if (!carId) throw new Error("Missing carId for payment");

    // 3) POST /api/payment/pay/:carid  (Authorization: Bearer <token>)
    console.log("Initiating payment for carId:", carId);
    console.log("Booking data:", {
        bookingId,
        email: booking.email,
        phoneNumber: booking.phoneNumber,
        pickupDate: booking.pickupDate,
        returnDate: booking.returnDate,
        totalAmount: booking.totalAmount
    });
    const res = await fetch(`${API_BASE}/api/payment/pay/${encodeURIComponent(carId)}`, {
      method: "POST",
      headers: {
        "Content-Type":"application/json",
        "Authorization": `Bearer ${user.token}`
      },
      body: JSON.stringify({
        bookingId,
        // Optional extras your backend may accept:
        email: booking.email,
        phoneNumber: booking.phoneNumber,
        pickupDate: booking.pickupDate,
        returnDate: booking.returnDate,
        totalAmount: booking.totalAmount
      })
    });

    if (!res.ok) {
      const err = await res.json().catch(()=>({}));
      if (res.status === 401) {
        showToast("Session expired. Please login again.", 3000, "#f44336");
        setTimeout(()=>window.location.href="login.html", 1200);
        return;
      }
      throw new Error(err.message || `Payment init failed (${res.status})`);
    }

    const data = await res.json();
    const link = data.redirectUrl || data.paymentLink || data.data?.link || data.paymentUrl;
    if (link) {
      window.location.href = link; // Flutterwave checkout
      return;
    }
    // Fallback: no link returned
    showToast("Payment started. Redirecting to dashboard...", 2500);
    setTimeout(()=>window.location.href='dashboard.html', 1500);

  } catch (e) {
    console.error(e);
    showToast(e.message || "Payment error. Please try again.", 3000, "#f44336");
    if (payBtn){ payBtn.disabled = false; payBtn.textContent = "Proceed to Payment"; }
    if (submitBtn){ submitBtn.disabled = false; }
  }
}

async function submitBookingOnly(){
  const user = getCurrentUser();
  if (!user) { showToast("Please login first",3000,"#f44336"); setTimeout(()=>location.href="login.html", 1200); return; }
  const submitBtn = document.getElementById("submit-booking-btn");
  const payBtn = document.getElementById("pay-btn");
  if (submitBtn){ submitBtn.disabled = true; submitBtn.textContent = "Submitting..."; }
  if (payBtn){ payBtn.disabled = true; }
  try {
    const result = await submitBookingToBackend();
    if (!result.success) throw new Error(result.error || "Failed to submit booking");
    showToast("Booking submitted! Redirecting to dashboard...", 2500);
    setTimeout(()=>window.location.href='dashboard.html', 1500);
  } catch (e) {
    console.error(e);
    showToast(e.message || "Failed to submit booking.", 3000, "#f44336");
    if (submitBtn){ submitBtn.disabled = false; submitBtn.textContent = "Submit Booking Only"; }
    if (payBtn){ payBtn.disabled = false; }
  }
}

// ---------- Init (do NOT auto-redirect to login; render summary first) ----------
document.addEventListener("DOMContentLoaded", () => {
  const booking = getBookingSafe();
  if (booking) {
    renderBooking(booking);
  } else {
    document.getElementById("checkout-content").innerHTML = `
      <div class="error-message">
        <h3>No booking found</h3>
        <p>Please go back and book a car first.</p>
        <button onclick="window.location.href='cars.html'" class="btn btn-primary">Book a Car</button>
      </div>`;
  }
  // Wire buttons (event delegation optional)
  document.addEventListener("click", (e)=>{
    if (e.target && e.target.id === "pay-btn") initiatePayment();
    if (e.target && e.target.id === "submit-booking-btn") submitBookingOnly();
  });
});
</script>

<!-- Optional: a compact, always-present summary block location -->
<div id="booking-summary"></div>
</body>
</html>