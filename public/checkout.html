<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Checkout - Silas Car Rentals</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
<header class="navbar">
  <div class="container nav-inner">
    <a href="index.html" class="brand"><div class="brand-mark">SC</div><span>Silas Car Rentals</span></a>
    <button onclick="window.history.back()" class="btn btn-outline">← Back</button>
  </div>
</header>

<main class="section container">
  <h2>Checkout</h2>

  <div id="checkout-summary" style="margin-bottom:20px; padding:10px; border:1px solid #ccc; border-radius:8px;">
    <!-- Booking details will go here -->
  </div>

  <button id="pay-btn" class="btn">Make Payment</button>
  <div class="toast" id="toast"></div>
</main>

<script>
const API_BASE = "https://techyjaunt-auth-go43.onrender.com";
const placeholderImage = "https://vehicle-images.dealerinspire.com/a1a7-11002896/W1KAF4GB4SR252999/00f2d6ad30e089cb5c02791d58c3af6a.jpg";

let lastBooking = JSON.parse(localStorage.getItem("lastBooking")) || null;

function showToast(msg, ms=3000) {
  const toast = document.getElementById("toast");
  toast.textContent = msg;
  toast.classList.add("show");
  setTimeout(() => toast.classList.remove("show"), ms);
}

function renderBooking(booking) {
  document.getElementById("checkout-summary").innerHTML = `
    <img src="${booking.car.image || placeholderImage}" alt="${booking.car.make}" style="max-width:300px; border-radius:8px;">
    <h3>${booking.car.make} ${booking.car.model}</h3>
    <p><strong>₦${booking.car.price.toLocaleString()}</strong> / day</p>
    <p><strong>Pickup:</strong> ${booking.pickupDate}</p>
    <p><strong>Return:</strong> ${booking.returnDate}</p>
    <p><strong>Phone:</strong> ${booking.phoneNumber}</p>
  `;
}

async function initiatePayment() {
  const token = localStorage.getItem("token");
  if (!token) {
    showToast("Please login first");
    setTimeout(() => window.location.href = "login.html", 1500);
    return;
  }

  if (!lastBooking || !lastBooking.car || !lastBooking.car._id) {
    showToast("No booking found. Please book a car first.");
    return;
  }

  try {
    const res = await fetch(`${API_BASE}/api/payment/pay/${lastBooking.car._id}`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${token}`
      },
      body: JSON.stringify({
        pickupDate: lastBooking.pickupDate,
        returnDate: lastBooking.returnDate,
        phoneNumber: lastBooking.phoneNumber
      })
    });

    const data = await res.json();
    if (!res.ok) throw new Error(data.message || "Payment initiation failed");

    const paymentLink = data.redirectUrl || data.paymentLink;
    if (paymentLink) {
      window.location.href = paymentLink;
    } else {
      showToast("No payment link returned from backend");
    }
  } catch (err) {
    showToast(err.message || "Payment error");
  }
}

document.getElementById("pay-btn").addEventListener("click", initiatePayment);

// Init
if (lastBooking) {
  renderBooking(lastBooking);
} else {
  document.getElementById("checkout-summary").innerHTML = "<p>No booking found. Please go back and book a car.</p>";
}
</script>
</body>
</html>
