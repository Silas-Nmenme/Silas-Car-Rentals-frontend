<!doctype html>
<html lang="en" data-bs-theme="light">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>View More Cars - Silas Car Rentals</title>
  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"/>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" rel="stylesheet"/>
  <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet"/>
  <link rel="stylesheet" href="header.css">
  <link rel="stylesheet" href="cars.css">
  <link rel="stylesheet" href="dropdown.css">
<style>
    :root {
    }
</style>
</head>
<body>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
<script>AOS.init();</script>

<script>
const API_BASE = "https://techyjaunt-auth-go43.onrender.com";
const placeholderImage = "https://vehicle-images.dealerinspire.com/a1a7-11002896/W1KAF4GB4SR252999/00f2d6ad30e089cb5c02791d58c3af6a.jpg";

let allCars = [];
let filteredCars = [];
let currentPage = 1;
const carsPerPage = 6;

// Fetch cars from backend
async function fetchCars() {
  try {
    const res = await fetch(`${API_BASE}/cars`);
    if (!res.ok) throw new Error("Failed to fetch cars");
    const data = await res.json();
    allCars = data;
    filteredCars = [...allCars];
    renderCars(paginate(filteredCars, currentPage));
    updateStats();
    toggleLoadMore();
  } catch (err) {
    showToast(err.message, "error");
  }
}

// Pagination helper
function paginate(arr, page) {
  const start = (page - 1) * carsPerPage;
  return arr.slice(start, start + carsPerPage);
}

// Update quick stats
function updateStats() {
  document.getElementById("total-cars").textContent = allCars.length;
  document.getElementById("available-cars").textContent = allCars.filter(c => c.available !== false).length;
  const avgPrice = allCars.length > 0 ? Math.round(allCars.reduce((a, b) => a + b.price, 0) / allCars.length) : 0;
  document.getElementById("avg-price").textContent = `₦${avgPrice}`;
}

// Toggle Load More button
function toggleLoadMore() {
  const btn = document.getElementById("load-more");
  if (filteredCars.length > currentPage * carsPerPage) {
    btn.style.display = "inline-block";
  } else {
    btn.style.display = "none";
  }
}

// Apply filters
function applyFilters() {
  const query = document.getElementById("search-input").value.toLowerCase();
  const type = document.getElementById("type-filter").value;
  const price = document.getElementById("price-filter").value;
  filteredCars = allCars.filter(car => {
    let matches = true;
    if (query && !car.name.toLowerCase().includes(query) && !car.tags.some(t => t.toLowerCase().includes(query))) {
      matches = false;
    }
    if (type && car.type !== type) matches = false;
    if (price) {
      const [min, max] = price.split("-");
      if (max) {
        if (car.price < +min || car.price > +max) matches = false;
      } else if (price.includes("+")) {
        if (car.price < +min) matches = false;
      }
    }
    return matches;
  });
  currentPage = 1;
  renderCars(paginate(filteredCars, currentPage));
  updateStats();
  toggleLoadMore();
}

// Load more cars
function loadMoreCars() {
  currentPage++;
  const newCars = paginate(filteredCars, currentPage);
  appendCars(newCars);
  toggleLoadMore();
}

// Render car grid
function renderCars(cars) {
  const grid = document.getElementById("cars-grid");
  grid.innerHTML = "";
  appendCars(cars);
}

function appendCars(cars) {
  const grid = document.getElementById("cars-grid");
  cars.forEach(car => {
    const rating = car.rating || (Math.random() * 2 + 3).toFixed(1);
    const reviewCount = car.reviewCount || Math.floor(Math.random() * 50 + 5);
    const isAvailable = car.available !== false;
    const discount = car.discount || 0;
    const originalPrice = discount > 0 ? Math.round(car.price / (1 - discount/100)) : car.price;

    const card = document.createElement("div");
    card.className = "car-card card p-3 mb-4 position-relative";
    card.setAttribute("data-id", car._id);
    card.setAttribute("data-aos", "fade-up");
    card.setAttribute("data-aos-delay", "100");
    card.innerHTML = `
      ${!isAvailable ? '<div class="availability-badge bg-warning text-dark">Booked</div>' : ''}
      ${discount > 0 ? `<div class="discount-badge bg-danger text-white">-${discount}%</div>` : ''}

      <div class="position-relative">
        <img src="${car.image || placeholderImage}" alt="${car.name}" loading="lazy"
             class="card-img-top rounded" style="height: 200px; object-fit: cover;">
        <div class="car-overlay">
          <button class="btn btn-light btn-sm me-2" data-action="quick-view" data-id="${car._id}" title="Quick View">
            <i class="fas fa-eye"></i>
          </button>
          <button class="btn btn-light btn-sm me-2" data-action="compare" data-id="${car._id}" title="Compare">
            <i class="fas fa-balance-scale"></i>
          </button>
          <button class="btn btn-light btn-sm" data-action="share" data-id="${car._id}" title="Share">
            <i class="fas fa-share-alt"></i>
          </button>
        </div>
      </div>

      <div class="card-body p-0 mt-3">
        <div class="d-flex justify-content-between align-items-start mb-2">
          <h5 class="card-title mb-0 fw-bold">${car.name}</h5>
          <div class="rating">
            <div class="d-flex align-items-center">
              <div class="stars me-1">
                ${generateStars(rating)}
              </div>
              <small class="text-muted">(${reviewCount})</small>
            </div>
          </div>
        </div>

        <div class="car-features mb-3">
          <div class="d-flex flex-wrap gap-1">
            ${car.tags.slice(0, 3).map(tag => `<span class="badge bg-light text-dark">${tag}</span>`).join('')}
          </div>
        </div>

        <div class="car-specs mb-3">
          <div class="row g-2">
            <div class="col-6">
              <small class="d-block">Price</small>
              <span class="fw-bold text-success">₦${car.price.toLocaleString()}</span>
              ${discount > 0 ? `<small class="text-muted text-decoration-line-through ms-2">₦${originalPrice.toLocaleString()}</small>` : ''}
            </div>
            <div class="col-6">
              <small class="d-block">Type</small>
              <small class="fw-semibold">${car.type || 'N/A'}</small>
            </div>
            <div class="col-6">
              <small class="d-block">Year</small>
              <small class="fw-semibold">${car.year || 'N/A'}</small>
            </div>
            <div class="col-6">
              <small class="d-block">Seats</small>
              <small class="fw-semibold">${car.seats || 'N/A'}</small>
            </div>
          </div>
        </div>

        <div class="car-actions d-flex gap-2">
          <button class="btn btn-success flex-fill" data-action="add-to-cart" data-id="${car._id}" ${!isAvailable ? 'disabled' : ''}>
            <i class="fas fa-cart-plus me-1"></i>${!isAvailable ? 'Booked' : 'Add to Cart'}
          </button>
          <button class="btn btn-outline-danger" data-action="wishlist" data-id="${car._id}">
            <i class="fas fa-heart"></i>
          </button>
          <button class="btn btn-outline-warning" data-action="save" data-id="${car._id}">
            <i class="fas fa-bookmark"></i>
          </button>
        </div>
      </div>
    `;
    grid.appendChild(card);
  });

  // Add event listeners
  setTimeout(() => {
    document.querySelectorAll('.car-card').forEach(card => {
      card.addEventListener('click', handleCarCardClick);
    });
  }, 100);

  document.getElementById("car-count").textContent = `${filteredCars.length} car${filteredCars.length !== 1 ? 's' : ''} available`;
}

function generateStars(rating) {
  const fullStars = Math.floor(rating);
  const hasHalfStar = rating % 1 !== 0;
  const emptyStars = 5 - fullStars - (hasHalfStar ? 1 : 0);

  let starsHtml = '';

  for (let i = 0; i < fullStars; i++) {
    starsHtml += '<i class="fas fa-star text-warning"></i>';
  }

  if (hasHalfStar) {
    starsHtml += '<i class="fas fa-star-half-alt text-warning"></i>';
  }

  for (let i = 0; i < emptyStars; i++) {
    starsHtml += '<i class="far fa-star text-warning"></i>';
  }

  return starsHtml;
}

function handleCarCardClick(event) {
  const target = event.target.closest('[data-action]');
  if (!target) return;

  event.preventDefault();
  const action = target.dataset.action;
  const carId = target.dataset.id;

  switch (action) {
    case 'quick-view':
      showQuickView(carId);
      break;
    case 'compare':
      toggleCompare(carId);
      break;
    case 'share':
      showShareModal(carId);
      break;
    case 'add-to-cart':
      addToCart(carId);
      break;
    case 'wishlist':
      toggleWishlist(carId);
      break;
    case 'save':
      toggleSaved(carId);
      break;
  }
}

function showQuickView(carId) {
  const car = allCars.find(c => c._id === carId);
  if (!car) return;

  const modal = new bootstrap.Modal(document.getElementById('quickViewModal'));
  const content = document.getElementById('quickViewContent');

  content.innerHTML = `
    <div class="row">
      <div class="col-md-6">
        <img src="${car.image || placeholderImage}" alt="${car.name}" class="img-fluid rounded">
      </div>
      <div class="col-md-6">
        <h4>${car.name}</h4>
        <div class="mb-3">
          <span class="h5 text-success">₦${car.price.toLocaleString()}</span>
          ${car.discount > 0 ? `<span class="text-muted text-decoration-line-through ms-2">₦${Math.round(car.price / (1 - car.discount/100)).toLocaleString()}</span>` : ''}
        </div>
        <div class="mb-3">
          ${generateStars(car.rating || 4.0)}
          <small class="text-muted">(${car.reviewCount || 0} reviews)</small>
        </div>
        <div class="mb-3">
          <h6>Specifications:</h6>
          <ul class="list-unstyled">
            <li><strong>Type:</strong> ${car.type || 'N/A'}</li>
            <li><strong>Year:</strong> ${car.year || 'N/A'}</li>
            <li><strong>Seats:</strong> ${car.seats || 'N/A'}</li>
            <li><strong>Transmission:</strong> ${car.transmission || 'N/A'}</li>
            <li><strong>Fuel:</strong> ${car.fuel || 'N/A'}</li>
          </ul>
        </div>
        <div class="mb-3">
          <h6>Features:</h6>
          <div class="d-flex flex-wrap gap-1">
            ${car.tags.map(tag => `<span class="badge bg-light text-dark">${tag}</span>`).join('')}
          </div>
        </div>
      </div>
    </div>
  `;

  modal.show();
}

function toggleCompare(carId) {
  const index = compareList.indexOf(carId);
  if (index > -1) {
    compareList.splice(index, 1);
    showToast('Removed from compare list', 'info');
  } else {
    if (compareList.length >= 4) {
      showToast('Maximum 4 cars can be compared', 'warning');
      return;
    }
    compareList.push(carId);
    showToast('Added to compare list', 'success');
  }

  localStorage.setItem('compareList', JSON.stringify(compareList));
  updateCompareButton();
}

function updateCompareButton() {
  const btn = document.getElementById('compare-btn');
  const count = document.getElementById('compare-count');
  count.textContent = compareList.length;
  btn.disabled = compareList.length === 0;
}

function showShareModal(carId) {
  const car = allCars.find(c => c._id === carId);
  if (!car) return;

  const modal = new bootstrap.Modal(document.getElementById('shareModal'));
  const content = document.getElementById('shareContent');

  const shareUrl = `${window.location.origin}/car-details.html?id=${carId}`;

  content.innerHTML = `
    <div class="text-center">
      <h5>Share ${car.name}</h5>
      <p>Share this car with your friends!</p>
      <div class="input-group mb-3">
        <input type="text" class="form-control" id="share-link" value="${shareUrl}" readonly>
        <button class="btn btn-outline-primary" type="button" id="copy-link-btn">
          <i class="fas fa-copy"></i> Copy
        </button>
      </div>
      <div class="d-flex justify-content-center gap-2">
        <a href="https://wa.me/?text=${encodeURIComponent(`Check out this car: ${car.name} - ${shareUrl}`)}" target="_blank" class="btn btn-success">
          <i class="fab fa-whatsapp"></i>
        </a>
        <a href="https://twitter.com/intent/tweet?text=${encodeURIComponent(`Check out this car: ${car.name}`)}&url=${encodeURIComponent(shareUrl)}" target="_blank" class="btn btn-info">
          <i class="fab fa-twitter"></i>
        </a>
        <a href="https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(shareUrl)}" target="_blank" class="btn btn-primary">
          <i class="fab fa-facebook"></i>
        </a>
      </div>
    </div>
  `;

  modal.show();

  // Copy link functionality
  document.getElementById('copy-link-btn').addEventListener('click', () => {
    const linkInput = document.getElementById('share-link');
    linkInput.select();
    document.execCommand('copy');
    showToast('Link copied to clipboard!', 'success');
  });
}

function addToCart(carId) {
  const car = allCars.find(c => c._id === carId);
  if (!car) return;

  let cart = JSON.parse(localStorage.getItem('cart')) || [];
  const existingItem = cart.find(item => item._id === carId);

  if (existingItem) {
    existingItem.quantity += 1;
  } else {
    cart.push({ ...car, quantity: 1 });
  }

  localStorage.setItem('cart', JSON.stringify(cart));
  updateCartCount();
  showToast(`${car.name} added to cart!`, 'success');
}

function toggleWishlist(carId) {
  let wishlist = JSON.parse(localStorage.getItem('wishlist')) || [];
  const index = wishlist.indexOf(carId);

  if (index > -1) {
    wishlist.splice(index, 1);
    showToast('Removed from wishlist', 'info');
  } else {
    wishlist.push(carId);
    showToast('Added to wishlist', 'success');
  }

  localStorage.setItem('wishlist', JSON.stringify(wishlist));
  updateWishlistCount();
}

function toggleSaved(carId) {
  let saved = JSON.parse(localStorage.getItem('saved')) || [];
  const index = saved.indexOf(carId);

  if (index > -1) {
    saved.splice(index, 1);
    showToast('Removed from saved', 'info');
  } else {
    saved.push(carId);
    showToast('Added to saved', 'success');
  }

  localStorage.setItem('saved', JSON.stringify(saved));
  updateSavedCount();
}

function updateCartCount() {
  const cart = JSON.parse(localStorage.getItem('cart')) || [];
  const count = cart.reduce((sum, item) => sum + item.quantity, 0);
  document.getElementById('cart-count').textContent = count;
}

function updateWishlistCount() {
  const wishlist = JSON.parse(localStorage.getItem('wishlist')) || [];
  document.getElementById('wishlist-count').textContent = wishlist.length;
}

function updateSavedCount() {
  const saved = JSON.parse(localStorage.getItem('saved')) || [];
  document.getElementById('saved-count').textContent = saved.length;
}

function showToast(msg, type = 'info', ms = 3000) {
  const toast = document.getElementById("toast");

  toast.className = 'toast';
  toast.classList.add(`toast-${type}`);

  const iconMap = {
    success: 'fas fa-check-circle',
    error: 'fas fa-exclamation-circle',
    warning: 'fas fa-exclamation-triangle',
    info: 'fas fa-info-circle'
  };

  toast.innerHTML = `
    <i class="${iconMap[type]} toast-icon"></i>
    <span class="toast-message">${msg}</span>
    <button class="toast-close" onclick="hideToast()">&times;</button>
  `;

  toast.classList.add("show");

  setTimeout(() => hideToast(), ms);
}

function hideToast() {
  const toast = document.getElementById("toast");
  toast.classList.remove("show");
  toast.classList.add("hide");
  setTimeout(() => {
    toast.classList.remove("hide");
  }, 400);
}

function clearAllFilters() {
  document.getElementById("search-input").value = "";
  document.getElementById("price-filter").value = "";
  document.getElementById("type-filter").value = "";
  // Clear advanced filters
  document.getElementById("location-filter").value = "";
  document.getElementById("transmission-filter").value = "";
  document.getElementById("fuel-filter").value = "";
  document.getElementById("seats-filter").value = "";
  document.getElementById("year-filter").value = "";
  document.getElementById("rating-filter").value = "";
  document.getElementById("availability-filter").value = "";

  filteredCars = [...allCars];
  currentPage = 1;
  renderCars(paginate(filteredCars, currentPage));
  updateStats();
  toggleLoadMore();
  showToast('All filters cleared', 'info');
}

// Event listeners
document.getElementById("search-btn").addEventListener("click", applyFilters);
document.getElementById("clear-all-filters").addEventListener("click", () => {
  document.getElementById("search-input").value = "";
  document.getElementById("type-filter").value = "";
  document.getElementById("price-filter").value = "";
  filteredCars = [...allCars];
  currentPage = 1;
  renderCars(paginate(filteredCars, currentPage));
  updateStats();
  toggleLoadMore();
});
document.getElementById("load-more").addEventListener("click", loadMoreCars);

// User Initialization
document.addEventListener("DOMContentLoaded", () => {
  const user = JSON.parse(localStorage.getItem("user")) || { name: "User" };
  document.getElementById("user-name").textContent = user.name;
  document.getElementById("welcome-user").textContent = user.name;
  const avatarLetter = user.name.charAt(0).toUpperCase();
  document.getElementById("nav-avatar").textContent = avatarLetter;
  document.getElementById("welcome-avatar").textContent = avatarLetter;
  document.getElementById("logout-button").addEventListener("click", () => {
    localStorage.removeItem("user");
    window.location.href = "login.html";
  });
  fetchCars();
});

// Additional JavaScript for enhanced functionality
let compareList = JSON.parse(localStorage.getItem('compareList')) || [];
let currentSort = 'price-asc';

// Initialize additional features
document.addEventListener("DOMContentLoaded", () => {
  // Initialize compare list
  updateCompareButton();

  // Initialize search suggestions
  initializeSearchSuggestions();

  // Initialize advanced filters
  initializeAdvancedFilters();

  // Initialize sorting
  initializeSorting();

  // Initialize scroll to top
  initializeScrollToTop();

  // Initialize theme toggle
  initializeThemeToggle();

  // Initialize sidebar
  initializeSidebar();

  // Initialize export functionality
  initializeExport();

  // Initialize saved searches
  initializeSavedSearches();
});

function initializeSearchSuggestions() {
  const searchInput = document.getElementById('search-input');
  const suggestions = document.getElementById('search-suggestions');

  searchInput.addEventListener('input', (e) => {
    const query = e.target.value.toLowerCase();
    if (query.length < 2) {
      suggestions.style.display = 'none';
      return;
    }

    const matchingCars = allCars.filter(car =>
      car.name.toLowerCase().includes(query) ||
      car.tags.some(tag => tag.toLowerCase().includes(query))
    ).slice(0, 5);

    if (matchingCars.length > 0) {
      suggestions.innerHTML = matchingCars.map(car => `
        <div class="suggestion-item" data-id="${car._id}">
          <i class="fas fa-car me-2"></i>${car.name}
        </div>
      `).join('');
      suggestions.style.display = 'block';
    } else {
      suggestions.style.display = 'none';
    }
  });

  // Handle suggestion clicks
  suggestions.addEventListener('click', (e) => {
    const item = e.target.closest('.suggestion-item');
    if (item) {
      const carId = item.dataset.id;
      const car = allCars.find(c => c._id === carId);
      if (car) {
        searchInput.value = car.name;
        suggestions.style.display = 'none';
        applyFilters();
      }
    }
  });

  // Hide suggestions when clicking outside
  document.addEventListener('click', (e) => {
    if (!searchInput.contains(e.target) && !suggestions.contains(e.target)) {
      suggestions.style.display = 'none';
    }
  });
}

function initializeAdvancedFilters() {
  const toggleBtn = document.getElementById('toggle-advanced-filters');
  const advancedFilters = document.getElementById('advanced-filters');
  const applyBtn = document.getElementById('apply-advanced-filters');

  toggleBtn.addEventListener('click', () => {
    const isVisible = advancedFilters.style.display !== 'none';
    advancedFilters.style.display = isVisible ? 'none' : 'block';
    toggleBtn.innerHTML = isVisible
      ? '<i class="fas fa-chevron-down me-1"></i>Show Advanced Filters'
      : '<i class="fas fa-chevron-up me-1"></i>Hide Advanced Filters';
  });

  applyBtn.addEventListener('click', () => {
    applyAdvancedFilters();
  });
}

function applyAdvancedFilters() {
  const location = document.getElementById('location-filter').value;
  const transmission = document.getElementById('transmission-filter').value;
  const fuel = document.getElementById('fuel-filter').value;
  const seats = document.getElementById('seats-filter').value;
  const year = document.getElementById('year-filter').value;
  const rating = document.getElementById('rating-filter').value;
  const availability = document.getElementById('availability-filter').value;

  filteredCars = allCars.filter(car => {
    let matches = true;

    if (location && car.location !== location) matches = false;
    if (transmission && car.transmission !== transmission) matches = false;
    if (fuel && car.fuel !== fuel) matches = false;
    if (seats && car.seats !== parseInt(seats)) matches = false;

    if (year) {
      const currentYear = new Date().getFullYear();
      if (year === '2024') {
        if (car.year < 2024) matches = false;
      } else if (year === '2020-2023') {
        if (car.year < 2020 || car.year > 2023) matches = false;
      } else if (year === '2015-2019') {
        if (car.year < 2015 || car.year > 2019) matches = false;
      } else if (year === '2010-2014') {
        if (car.year < 2010 || car.year > 2014) matches = false;
      }
    }

    if (rating) {
      const minRating = parseFloat(rating);
      if ((car.rating || 0) < minRating) matches = false;
    }

    if (availability === 'available' && car.available === false) matches = false;
    if (availability === 'booked' && car.available !== false) matches = false;

    return matches;
  });

  currentPage = 1;
  renderCars(paginate(filteredCars, currentPage));
  updateStats();
  toggleLoadMore();
  showToast('Advanced filters applied', 'success');
}

function initializeSorting() {
  document.querySelectorAll('.sort-option').forEach(option => {
    option.addEventListener('click', (e) => {
      e.preventDefault();
      const sortType = e.target.dataset.sort;
      currentSort = sortType;
      document.getElementById('current-sort').textContent = e.target.textContent;
      applySorting();
    });
  });
}

function applySorting() {
  filteredCars.sort((a, b) => {
    switch (currentSort) {
      case 'price-asc':
        return a.price - b.price;
      case 'price-desc':
        return b.price - a.price;
      case 'name-asc':
        return a.name.localeCompare(b.name);
      case 'name-desc':
        return b.name.localeCompare(a.name);
      case 'rating-desc':
        return (b.rating || 0) - (a.rating || 0);
      case 'year-desc':
        return (b.year || 0) - (a.year || 0);
      case 'popularity-desc':
        return (b.reviewCount || 0) - (a.reviewCount || 0);
      default:
        return 0;
    }
  });

  currentPage = 1;
  renderCars(paginate(filteredCars, currentPage));
  showToast('Cars sorted successfully', 'info');
}

function initializeScrollToTop() {
  const scrollBtn = document.getElementById('scroll-to-top');

  window.addEventListener('scroll', () => {
    if (window.pageYOffset > 300) {
      scrollBtn.classList.add('show');
    } else {
      scrollBtn.classList.remove('show');
    }
  });

  scrollBtn.addEventListener('click', () => {
    window.scrollTo({
      top: 0,
      behavior: 'smooth'
    });
  });
}

function initializeThemeToggle() {
  const themeToggle = document.getElementById('theme-toggle');
  const html = document.documentElement;

  // Set initial theme
  const savedTheme = localStorage.getItem('theme') || 'light';
  html.setAttribute('data-bs-theme', savedTheme);
  updateThemeIcon(savedTheme);

  themeToggle.addEventListener('click', () => {
    const currentTheme = html.getAttribute('data-bs-theme');
    const newTheme = currentTheme === 'light' ? 'dark' : 'light';

    html.setAttribute('data-bs-theme', newTheme);
    localStorage.setItem('theme', newTheme);
    updateThemeIcon(newTheme);

    showToast(`Switched to ${newTheme} theme`, 'info');
  });
}

function updateThemeIcon(theme) {
  const icon = document.querySelector('#theme-toggle i');
  if (theme === 'dark') {
    icon.className = 'fas fa-sun';
  } else {
    icon.className = 'fas fa-moon';
  }
}

function initializeSidebar() {
  // Populate sidebar links
  const sidebarLinks = [
    { href: 'home.html', icon: 'fas fa-home', text: 'Home' },
    { href: 'cars.html', icon: 'fas fa-car', text: 'Browse Cars' },
    { href: 'cart.html', icon: 'fas fa-shopping-cart', text: 'Cart' },
    { href: 'wishlist.html', icon: 'fas fa-heart', text: 'Wishlist' },
    { href: 'saved.html', icon: 'fas fa-bookmark', text: 'Saved' },
    { href: 'orders.html', icon: 'fas fa-box', text: 'My Orders' },
    { href: 'profile.html', icon: 'fas fa-user', text: 'Profile' },
  ];

  const sidebarContainer = document.getElementById('sidebar-links');
  const sidebarDesktopContainer = document.getElementById('sidebar-links-desktop');

  sidebarLinks.forEach(link => {
    const linkElement = document.createElement('li');
    linkElement.innerHTML = `<a href="${link.href}" class="nav-link"><i class="${link.icon} me-2"></i>${link.text}</a>`;
    sidebarContainer.appendChild(linkElement.cloneNode(true));
    sidebarDesktopContainer.appendChild(linkElement);
  });
}

function initializeExport() {
  document.getElementById('export-btn').addEventListener('click', () => {
    const data = filteredCars.map(car => ({
      Name: car.name,
      Price: car.price,
      Type: car.type || 'N/A',
      Year: car.year || 'N/A',
      Seats: car.seats || 'N/A',
      Rating: car.rating || 'N/A',
      Available: car.available !== false ? 'Yes' : 'No'
    }));

    const csv = convertToCSV(data);
    downloadCSV(csv, 'car-list.csv');
    showToast('Car list exported successfully', 'success');
  });
}

function convertToCSV(data) {
  const headers = Object.keys(data[0]);
  const csvRows = [headers.join(',')];

  data.forEach(row => {
    const values = headers.map(header => {
      const value = row[header];
      return typeof value === 'string' && value.includes(',') ? `"${value}"` : value;
    });
    csvRows.push(values.join(','));
  });

  return csvRows.join('\n');
}

function downloadCSV(csv, filename) {
  const blob = new Blob([csv], { type: 'text/csv' });
  const url = window.URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  window.URL.revokeObjectURL(url);
}

function initializeSavedSearches() {
  document.getElementById('save-search-btn').addEventListener('click', () => {
    const searchData = {
      query: document.getElementById('search-input').value,
      type: document.getElementById('type-filter').value,
      price: document.getElementById('price-filter').value,
      location: document.getElementById('location-filter').value,
      transmission: document.getElementById('transmission-filter').value,
      fuel: document.getElementById('fuel-filter').value,
      seats: document.getElementById('seats-filter').value,
      year: document.getElementById('year-filter').value,
      rating: document.getElementById('rating-filter').value,
      availability: document.getElementById('availability-filter').value,
      sort: currentSort,
      timestamp: new Date().toISOString()
    };

    let savedSearches = JSON.parse(localStorage.getItem('savedSearches')) || [];
    savedSearches.push(searchData);
    localStorage.setItem('savedSearches', JSON.stringify(savedSearches));

    showToast('Search saved successfully', 'success');
  });
}

// Enhanced applyFilters to include advanced filters
function applyFilters() {
  const query = document.getElementById("search-input").value.toLowerCase();
  const type = document.getElementById("type-filter").value;
  const price = document.getElementById("price-filter").value;

  filteredCars = allCars.filter(car => {
    let matches = true;
    if (query && !car.name.toLowerCase().includes(query) && !car.tags.some(t => t.toLowerCase().includes(query))) {
      matches = false;
    }
    if (type && car.type !== type) matches = false;
    if (price) {
      const [min, max] = price.split("-");
      if (max) {
        if (car.price < +min || car.price > +max) matches = false;
      } else if (price.includes("+")) {
        if (car.price < +min) matches = false;
      }
    }
    return matches;
  });

  currentPage = 1;
  renderCars(paginate(filteredCars, currentPage));
  updateStats();
  toggleLoadMore();
}
</script>
</body>
</html>
