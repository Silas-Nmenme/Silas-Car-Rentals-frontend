<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Payment System Test - Silas Car Rentals</title>
  <link rel="stylesheet" href="style.css" />
  <script src="booking-fix-enhanced.js"></script>
  <script src="payment-fix-enhanced.js"></script>
  <style>
    .test-container {
      max-width: 800px;
      margin: 0 auto;
      padding: 2rem;
    }
    
    .test-section {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 2rem;
      margin-bottom: 2rem;
      box-shadow: var(--shadow);
    }
    
    .test-header {
      color: var(--primary);
      margin-bottom: 1.5rem;
      border-bottom: 2px solid var(--primary);
      padding-bottom: 0.5rem;
    }
    
    .test-buttons {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
      margin: 1rem 0;
    }
    
    .test-result {
      background: var(--bg-soft);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 1rem;
      margin-top: 1rem;
      font-family: monospace;
      white-space: pre-wrap;
      max-height: 300px;
      overflow-y: auto;
    }
    
    .success {
      border-color: var(--success);
      background: rgba(34, 197, 94, 0.1);
    }
    
    .error {
      border-color: var(--danger);
      background: rgba(239, 68, 68, 0.1);
    }
    
    .warning {
      border-color: var(--warning);
      background: rgba(245, 158, 11, 0.1);
    }
    
    .booking-demo {
      background: var(--bg-soft);
      padding: 1.5rem;
      border-radius: var(--radius);
      margin: 1rem 0;
    }
  </style>
</head>
<body>

<main class="test-container">
  <h1>Payment System Test Suite</h1>
  <p>Test the enhanced payment system functionality</p>
  
  <div class="test-section">
    <h2 class="test-header">1. System Initialization</h2>
    <p>Check if payment system is properly loaded and initialized</p>
    
    <div class="test-buttons">
      <button onclick="testSystemInit()" class="btn btn-primary">Test System Initialization</button>
      <button onclick="testPaymentMethods()" class="btn btn-secondary">Test Payment Methods</button>
    </div>
    
    <div id="system-init-result" class="test-result"></div>
  </div>
  
  <div class="test-section">
    <h2 class="test-header">2. Mock Payment Processing</h2>
    <p>Test payment processing with mock data (no real API calls)</p>
    
    <div class="booking-demo">
      <h3>Demo Booking Data</h3>
      <p>This creates a sample booking for testing purposes</p>
    </div>
    
    <div class="test-buttons">
      <button onclick="createTestBooking()" class="btn btn-primary">Create Test Booking</button>
      <button onclick="testMockPayment()" class="btn btn-secondary">Test Mock Payment</button>
      <button onclick="testPaymentFallback()" class="btn btn-outline">Test Fallback Payment</button>
    </div>
    
    <div id="mock-payment-result" class="test-result"></div>
  </div>
  
  <div class="test-section">
    <h2 class="test-header">3. Error Handling</h2>
    <p>Test error scenarios and recovery mechanisms</p>
    
    <div class="test-buttons">
      <button onclick="testErrorHandling()" class="btn btn-warning">Test Error Handling</button>
      <button onclick="testRetryMechanism()" class="btn btn-secondary">Test Retry Mechanism</button>
    </div>
    
    <div id="error-handling-result" class="test-result"></div>
  </div>
  
  <div class="test-section">
    <h2 class="test-header">4. Integration Tests</h2>
    <p>Test integration with booking system</p>
    
    <div class="test-buttons">
      <button onclick="testBookingIntegration()" class="btn btn-primary">Test Booking Integration</button>
      <button onclick="testPaymentSuccessFlow()" class="btn btn-success">Test Success Flow</button>
      <button onclick="testPaymentFailureFlow()" class="btn btn-danger">Test Failure Flow</button>
    </div>
    
    <div id="integration-result" class="test-result"></div>
  </div>
  
  <div class="test-section">
    <h2 class="test-header">5. Cleanup & Reset</h2>
    <p>Clear test data and reset system state</p>
    
    <div class="test-buttons">
      <button onclick="clearTestData()" class="btn btn-outline">Clear Test Data</button>
      <button onclick="resetSystem()" class="btn btn-secondary">Reset System</button>
    </div>
    
    <div id="cleanup-result" class="test-result"></div>
  </div>
</main>

<script>
function logResult(elementId, message, type = 'info') {
  const element = document.getElementById(elementId);
  element.textContent = message;
  element.className = 'test-result';
  if (type === 'success') element.classList.add('success');
  if (type === 'error') element.classList.add('error');
  if (type === 'warning') element.classList.add('warning');
}

function testSystemInit() {
  try {
    if (typeof PaymentManager === 'undefined') {
      throw new Error('PaymentManager is not defined');
    }
    
    if (typeof PaymentManager.init !== 'function') {
      throw new Error('PaymentManager.init is not a function');
    }
    
    PaymentManager.init();
    
    const methods = PaymentManager.getAvailablePaymentMethods();
    if (!Array.isArray(methods) || methods.length === 0) {
      throw new Error('No payment methods available');
    }
    
    logResult('system-init-result', 
      `‚úÖ System initialized successfully!\n\nAvailable Payment Methods:\n${
        methods.map(m => `‚Ä¢ ${m.icon} ${m.name}: ${m.description}`).join('\n')
      }`, 
      'success'
    );
  } catch (error) {
    logResult('system-init-result', `‚ùå System initialization failed:\n${error.message}`, 'error');
  }
}

function testPaymentMethods() {
  try {
    const methods = PaymentManager.getAvailablePaymentMethods();
    const result = methods.map(method => ({
      id: method.id,
      name: method.name,
      icon: method.icon,
      description: method.description
    }));
    
    logResult('system-init-result', 
      `‚úÖ Payment methods retrieved:\n${JSON.stringify(result, null, 2)}`, 
      'success'
    );
  } catch (error) {
    logResult('system-init-result', `‚ùå Failed to get payment methods:\n${error.message}`, 'error');
  }
}

function createTestBooking() {
  try {
    const testBooking = {
      _id: 'test_booking_' + Date.now(),
      isMultiCar: false,
      car: {
        _id: 'test_car_001',
        make: 'Toyota',
        model: 'Camry',
        year: 2023,
        price: 25000,
        image: 'https://images.unsplash.com/photo-1549317661-bd32c8ce0db2'
      },
      pickupDate: new Date(Date.now() + 86400000).toISOString().split('T')[0],
      returnDate: new Date(Date.now() + 172800000).toISOString().split('T')[0],
      email: 'test@example.com',
      phoneNumber: '+1234567890',
      totalAmount: 50000,
      days: 2
    };
    
    BookingManager.setBooking(testBooking);
    
    const stored = BookingManager.getBooking();
    logResult('mock-payment-result', 
      `‚úÖ Test booking created successfully!\n\nBooking Details:\n${JSON.stringify(stored, null, 2)}`, 
      'success'
    );
  } catch (error) {
    logResult('mock-payment-result', `‚ùå Failed to create test booking:\n${error.message}`, 'error');
  }
}

async function testMockPayment() {
  try {
    const booking = BookingManager.getBooking();
    if (!booking) {
      throw new Error('No booking found. Create a test booking first.');
    }
    
    logResult('mock-payment-result', 'üîÑ Processing mock payment...', 'info');
    
    const result = await PaymentManager.processMockPayment({
      bookingId: booking._id,
      amount: booking.totalAmount,
      currency: 'NGN',
      paymentMethod: 'card'
    });
    
    logResult('mock-payment-result', 
      `‚úÖ Mock payment processed!\n\nResult:\n${JSON.stringify(result, null, 2)}`, 
      'success'
    );
  } catch (error) {
    logResult('mock-payment-result', `‚ùå Mock payment failed:\n${error.message}`, 'error');
  }
}

async function testPaymentFallback() {
  try {
    const booking = BookingManager.getBooking();
    if (!booking) {
      throw new Error('No booking found. Create a test booking first.');
    }
    
    logResult('mock-payment-result', 'üîÑ Testing payment fallback...', 'info');
    
    // Simulate primary gateway failure
    const originalProcess = PaymentManager.processWithPrimaryGateway;
    PaymentManager.processWithPrimaryGateway = async () => {
      throw new Error('Primary gateway simulation failure');
    };
    
    const result = await PaymentManager.processPayment(booking);
    
    // Restore original method
    PaymentManager.processWithPrimaryGateway = originalProcess;
    
    logResult('mock-payment-result', 
      `‚úÖ Fallback payment processed!\n\nResult:\n${JSON.stringify(result, null, 2)}`, 
      'success'
    );
  } catch (error) {
    logResult('mock-payment-result', `‚ùå Fallback payment failed:\n${error.message}`, 'error');
  }
}

function testErrorHandling() {
  try {
    // Test error handling functions
    const testError = new Error('Test error message');
    
    // Test payment failure handling
    PaymentManager.handlePaymentFailure(testError);
    
    const booking = BookingManager.getBooking();
    if (booking && booking.paymentError === testError.message) {
      logResult('error-handling-result', 
        '‚úÖ Error handling working correctly!\n‚Ä¢ Error stored in booking\n‚Ä¢ User notified appropriately', 
        'success'
      );
    } else {
      logResult('error-handling-result', 
        '‚ö†Ô∏è Error handling partially working\n‚Ä¢ Check browser console for notifications', 
        'warning'
      );
    }
  } catch (error) {
    logResult('error-handling-result', `‚ùå Error handling test failed:\n${error.message}`, 'error');
  }
}

async function testRetryMechanism() {
  try {
    const booking = BookingManager.getBooking();
    if (!booking) {
      throw new Error('No booking found. Create a test booking first.');
    }
    
    logResult('error-handling-result', 'üîÑ Testing retry mechanism...', 'info');
    
    // Test with different payment methods
    const methods = PaymentManager.getAvailablePaymentMethods();
    
    let results = [];
    for (const method of methods) {
      try {
        const result = await PaymentManager.processPayment(booking, method.id);
        results.push({ method: method.id, status: 'success', result });
      } catch (error) {
        results.push({ method: method.id, status: 'error', error: error.message });
      }
    }
    
    logResult('error-handling-result', 
      `‚úÖ Retry mechanism test completed!\n\nResults:\n${
        results.map(r => `‚Ä¢ ${r.method}: ${r.status}${r.error ? ` - ${r.error}` : ''}`).join('\n')
      }`, 
      'success'
    );
  } catch (error) {
    logResult('error-handling-result', `‚ùå Retry mechanism test failed:\n${error.message}`, 'error');
  }
}

function testBookingIntegration() {
  try {
    const booking = BookingManager.getBooking();
    if (!booking) {
      throw new Error('No booking found. Create a test booking first.');
    }
    
    // Test validation
    const validation = BookingManager.validateBooking(booking);
    
    logResult('integration-result', 
      `‚úÖ Booking integration working!\n\nValidation Result:\n${
        JSON.stringify(validation, null, 2)
      }`, 
      'success'
    );
  } catch (error) {
    logResult('integration-result', `‚ùå Booking integration test failed:\n${error.message}`, 'error');
  }
}

async function testPaymentSuccessFlow() {
  try {
    const booking = BookingManager.getBooking();
    if (!booking) {
      throw new Error('No booking found. Create a test booking first.');
    }
    
    logResult('integration-result', 'üîÑ Testing success flow...', 'info');
    
    // Mock a successful payment
    const mockSuccessResult = {
      success: true,
      paymentId: 'test_payment_' + Date.now(),
      status: 'completed',
      message: 'Test payment successful',
      redirectUrl: 'payment-success.html'
    };
    
    PaymentManager.handlePaymentSuccess(mockSuccessResult);
    
    logResult('integration-result', 
      `‚úÖ Success flow working!\n\nPayment processed successfully\nRedirecting to: ${mockSuccessResult.redirectUrl}`, 
      'success'
    );
  } catch (error) {
    logResult('integration-result', `‚ùå Success flow test failed:\n${error.message}`, 'error');
  }
}

async function testPaymentFailureFlow() {
  try {
    const booking = BookingManager.getBooking();
    if (!booking) {
      throw new Error('No booking found. Create a test booking first.');
    }
    
    logResult('integration-result', 'üîÑ Testing failure flow...', 'info');
    
    // Mock a failed payment
    const mockError = new Error('Test payment failure - insufficient funds');
    
    PaymentManager.handlePaymentFailure(mockError);
    
    const updatedBooking = BookingManager.getBooking();
    
    logResult('integration-result', 
      `‚úÖ Failure flow working!\n\nError handled:\n‚Ä¢ Error: ${mockError.message}\n‚Ä¢ Stored in booking: ${updatedBooking.paymentError === mockError.message}`, 
      'success'
    );
  } catch (error) {
    logResult('integration-result', `‚ùå Failure flow test failed:\n${error.message}`, 'error');
  }
}

function clearTestData() {
  try {
    BookingManager.clearBooking();
    localStorage.removeItem('cart');
    
    logResult('cleanup-result', 
      '‚úÖ Test data cleared successfully!\n‚Ä¢ Booking cleared\n‚Ä¢ Cart cleared', 
      'success'
    );
  } catch (error) {
    logResult('cleanup-result', `‚ùå Failed to clear test data:\n${error.message}`, 'error');
  }
}

function resetSystem() {
  try {
    clearTestData();
    
    // Reload payment manager
    if (typeof PaymentManager !== 'undefined' && typeof PaymentManager.init === 'function') {
      PaymentManager.init();
    }
    
    logResult('cleanup-result', 
      '‚úÖ System reset successfully!\n‚Ä¢ All test data cleared\n‚Ä¢ Payment system reinitialized', 
      'success'
    );
  } catch (error) {
    logResult('cleanup-result', `‚ùå System reset failed:\n${error.message}`, 'error');
  }
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
  logResult('system-init-result', 'Ready to test payment system. Click buttons to run tests.', 'info');
  logResult('mock-payment-result', 'Create a test booking first to test payment processing.', 'info');
  logResult('error-handling-result', 'Test error handling and recovery mechanisms.', 'info');
  logResult('integration-result', 'Test integration with booking system.', 'info');
  logResult('cleanup-result', 'Use these buttons to clear test data when done.', 'info');
});
</script>
</body>
</html>
