<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dashboard ‚Äî Silas Car Rentals</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    /* Modal Styles */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.6);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      animation: fadeIn 0.3s ease;
    }
    .modal {
      background: #fff;
      border-radius: 15px;
      padding: 20px;
      max-width: 600px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      animation: slideUp 0.3s ease;
    }
    .modal h2 { margin-bottom: 10px; }
    .modal .card {
      border: 1px solid #ddd;
      border-radius: 12px;
      padding: 15px;
      margin-bottom: 10px;
      text-align: center;
    }
    .modal .btn {
      margin: 5px;
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    @keyframes slideUp {
      from { transform: translateY(20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
  </style>
</head>
<body class="dashboard-body">

  <header class="navbar">
    <div class="container nav-inner">
      <a href="index.html" class="brand">
        <div class="brand-mark">SC</div>
        <span class="brand-name">Silas Dashboard</span>
      </a>
      <div class="nav-actions">
        <button class="btn-sm btn-ghost" id="cart-btn">Cart (<span id="cart-count">0</span>)</button>
        <button class="btn-sm btn-ghost" id="logout-btn">Logout</button>
      </div>
    </div>
  </header>

  <main class="container section">
    <h1>Welcome, <span id="dash-username">User</span> üëã</h1>
    <p class="meta">Manage your rentals, wishlist, saved cars, and (if admin) view analytics.</p>

    <!-- User Stats -->
    <section class="stats-grid" id="user-stats">
      <div class="stat-card">
        <h2 id="total-rentals">0</h2>
        <p>Total Rentals</p>
      </div>
      <div class="stat-card clickable" id="wishlist-stat">
        <h2 id="wishlist-count-stat">0</h2>
        <p>Wishlist Items</p>
      </div>
      <div class="stat-card clickable" id="saved-cars-stat">
        <h2 id="saved-count-stat">0</h2>
        <p>Saved Cars</p>
      </div>
      <div class="stat-card clickable" id="cart-stat">
        <h2 id="cart-count-stat">0</h2>
        <p>Cart</p>
      </div>
    </section>

    <!-- Rentals Table -->
    <section>
      <h2>Rental History</h2>
      <table class="data-table">
        <thead>
          <tr>
            <th>Car</th>
            <th>Start</th>
            <th>End</th>
            <th>Price</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody id="rentals-table-body">
          <tr><td colspan="5" class="meta">Loading...</td></tr>
        </tbody>
      </table>
    </section>

    <!-- Wishlist -->
    <section>
      <h2>My Wishlist ‚ù§Ô∏è 
        <a href="book.html?section=wishlist" class="btn btn-sm btn-primary view-all-btn" style="display:none;">View All</a>
      </h2>
      <div class="grid" id="wishlist-grid">
        <p class="meta">Loading wishlist...</p>
      </div>
    </section>

    <!-- Saved Cars -->
    <section>
      <h2>Saved Cars üöó
        <a href="book.html?section=savedCars" class="btn btn-sm btn-primary view-all-btn" style="display:none;">View All</a>
      </h2>
      <div class="grid" id="saved-cars-grid">
        <p class="meta">Loading saved cars...</p>
      </div>
    </section>

    <!-- Admin Analytics -->
    <section id="admin-analytics" class="hidden">
      <h2>Admin Analytics üìä</h2>
      <div class="stats-grid">
        <div class="stat-card">
          <h2 id="admin-total-users">0</h2>
          <p>Total Users</p>
        </div>
        <div class="stat-card">
          <h2 id="admin-total-cars">0</h2>
          <p>Cars Listed</p>
        </div>
        <div class="stat-card">
          <h2 id="admin-total-revenue">‚Ç¶0</h2>
          <p>Total Revenue</p>
        </div>
      </div>

      <h3 style="margin-top:20px">Recent Bookings</h3>
      <table class="data-table">
        <thead>
          <tr>
            <th>User</th>
            <th>Car</th>
            <th>Period</th>
            <th>Amount</th>
          </tr>
        </thead>
        <tbody id="admin-bookings-body">
          <tr><td colspan="4" class="meta">Loading...</td></tr>
        </tbody>
      </table>
    </section>
  </main>

  <!-- Modals -->
  <div class="modal-overlay" id="modal-overlay">
    <div class="modal" id="modal-content">
      <h2 id="modal-title">Items</h2>
      <div id="modal-items"></div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script type="module" src="app.js"></script>
  <script type="module">
    import { BASE_URL, ENDPOINTS, showToast } from './app.js';

    const token = localStorage.getItem('token');
    if (!token) {
      showToast('Please login first');
      setTimeout(() => window.location.href = 'login.html', 1500);
    }

    const userNameEl = document.getElementById('dash-username');
    const logoutBtn = document.getElementById('logout-btn');

    const totalRentalsEl = document.getElementById('total-rentals');
    const wishlistCountEl = document.getElementById('wishlist-count-stat');
    const savedCountEl = document.getElementById('saved-count-stat');
    const cartCountEl = document.getElementById('cart-count');
    const cartCountStatEl = document.getElementById('cart-count-stat');

    const rentalsTableBody = document.getElementById('rentals-table-body');
    const wishlistGrid = document.getElementById('wishlist-grid');
    const savedCarsGrid = document.getElementById('saved-cars-grid');

    const adminAnalyticsSection = document.getElementById('admin-analytics');
    const adminTotalUsersEl = document.getElementById('admin-total-users');
    const adminTotalCarsEl = document.getElementById('admin-total-cars');
    const adminTotalRevenueEl = document.getElementById('admin-total-revenue');
    const adminBookingsBody = document.getElementById('admin-bookings-body');

    const modalOverlay = document.getElementById('modal-overlay');
    const modalTitle = document.getElementById('modal-title');
    const modalItems = document.getElementById('modal-items');

    function openModal(title, items, type) {
      modalTitle.textContent = title;
      if (items.length === 0) {
        modalItems.innerHTML = `<p class="meta">No items in ${title.toLowerCase()}.</p>`;
      } else {
        modalItems.innerHTML = items.map(car => `
          <div class="card">
            <h3>${car.name}</h3>
            <p>‚Ç¶${car.price.toLocaleString()}</p>
            ${type === 'cart' 
              ? `<button class="btn btn-primary btn-sm" onclick='rentNow(${JSON.stringify(car).replace(/"/g, '&quot;')})'>Rent Now</button>` 
              : ''}
            <button class="btn btn-outline btn-sm" onclick='removeFrom("${type}", ${car.id})'>Remove</button>
          </div>
        `).join('');
      }
      modalOverlay.style.display = 'flex';
    }

    function closeModal() {
      modalOverlay.style.display = 'none';
    }

    window.removeFrom = function(key, id) {
      let arr = JSON.parse(localStorage.getItem(key)) || [];
      arr = arr.filter(c => c.id !== id);
      localStorage.setItem(key, JSON.stringify(arr));
      renderAllPreviews();
    };

    window.rentNow = function(car) {
      removeFrom('cart', car.id);
      localStorage.setItem('currentRental', JSON.stringify(car));
      window.location.href = 'book.html';
    };

    modalOverlay.addEventListener('click', e => {
      if (e.target === modalOverlay) closeModal();
    });

    document.addEventListener('keydown', e => {
      if (e.key === 'Escape') closeModal();
    });

    document.getElementById('wishlist-stat').addEventListener('click', () => {
      openModal('Wishlist', JSON.parse(localStorage.getItem('wishlist')) || [], 'wishlist');
    });
    document.getElementById('saved-cars-stat').addEventListener('click', () => {
      openModal('Saved Cars', JSON.parse(localStorage.getItem('savedCars')) || [], 'savedCars');
    });
    document.getElementById('cart-stat').addEventListener('click', () => {
      openModal('Cart', JSON.parse(localStorage.getItem('cart')) || [], 'cart');
    });
    document.getElementById('cart-btn').addEventListener('click', () => {
      openModal('Cart', JSON.parse(localStorage.getItem('cart')) || [], 'cart');
    });

    function renderPreview(id, storageKey) {
      const data = JSON.parse(localStorage.getItem(storageKey)) || [];
      const container = document.getElementById(id);
      const section = container.closest("section");
      const viewAllBtn = section.querySelector(".view-all-btn");

      if (data.length === 0) {
        container.innerHTML = `<p class="meta">No ${storageKey} yet.</p>`;
        if (viewAllBtn) viewAllBtn.style.display = "none";
      } else {
        container.innerHTML = data.slice(0, 3).map(car => `
          <div class="card">
            <h3>${car.name}</h3>
            <p>‚Ç¶${car.price.toLocaleString()}</p>
            <button class="btn btn-outline btn-sm" onclick='removeFrom("${storageKey}", ${car.id})'>Remove</button>
          </div>
        `).join("");
        if (viewAllBtn) viewAllBtn.style.display = "inline-block";
      }
    }

    function renderCounts() {
      wishlistCountEl.textContent = (JSON.parse(localStorage.getItem('wishlist')) || []).length;
      savedCountEl.textContent = (JSON.parse(localStorage.getItem('savedCars')) || []).length;
      const cartLength = (JSON.parse(localStorage.getItem('cart')) || []).length;
      cartCountEl.textContent = cartLength;
      cartCountStatEl.textContent = cartLength;
    }

    function renderAllPreviews() {
      renderCounts();
      renderPreview('wishlist-grid', 'wishlist');
      renderPreview('saved-cars-grid', 'savedCars');
    }

    async function fetchUserProfile() {
      try {
        const res = await fetch(BASE_URL + ENDPOINTS.authMe, {
          headers: { Authorization: 'Bearer ' + token }
        });
        if (!res.ok) throw new Error('Unauthorized');
        const user = await res.json();
        userNameEl.textContent = user.name || user.email || 'User';
        if (user.role === 'admin') {
          adminAnalyticsSection.classList.remove('hidden');
          loadAdminAnalytics();
        }
      } catch {
        showToast('Session expired. Redirecting...');
        setTimeout(() => {
          localStorage.removeItem('token');
          window.location.href = 'login.html';
        }, 1500);
      }
    }

    async function fetchUserStats() {
      try {
        const res = await fetch(BASE_URL + ENDPOINTS.userStats, {
          headers: { Authorization: 'Bearer ' + token }
        });
        if (!res.ok) throw new Error('Failed to load user stats');
        const stats = await res.json();
        totalRentalsEl.textContent = stats.totalRentals ?? 0;
      } catch {
        showToast('Failed to load user stats');
      }
    }

    async function fetchRentalHistory() {
      try {
        const res = await fetch(BASE_URL + ENDPOINTS.rentalHistory, {
          headers: { Authorization: 'Bearer ' + token }
        });
        if (!res.ok) throw new Error('Failed to load rental history');
        const rentals = await res.json();
        if (rentals.length === 0) {
          rentalsTableBody.innerHTML = `<tr><td colspan="5" class="meta">No rentals found</td></tr>`;
          return;
        }
        rentalsTableBody.innerHTML = rentals.map(rental => `
          <tr>
            <td>${rental.carName}</td>
            <td>${new Date(rental.startDate).toLocaleDateString()}</td>
            <td>${new Date(rental.endDate).toLocaleDateString()}</td>
            <td>‚Ç¶${rental.price.toLocaleString()}</td>
            <td>${rental.status}</td>
          </tr>
        `).join('');
      } catch {
        rentalsTableBody.innerHTML = `<tr><td colspan="5" class="meta">Failed to load rental history</td></tr>`;
      }
    }

    async function loadAdminAnalytics() {
      try {
        const res = await fetch(BASE_URL + ENDPOINTS.adminAnalytics, {
          headers: { Authorization: 'Bearer ' + token }
        });
        if (!res.ok) throw new Error('Failed to load admin analytics');
        const analytics = await res.json();
        adminTotalUsersEl.textContent = analytics.totalUsers ?? 0;
        adminTotalCarsEl.textContent = analytics.totalCars ?? 0;
        adminTotalRevenueEl.textContent = `‚Ç¶${(analytics.totalRevenue || 0).toLocaleString()}`;
        if (!analytics.recentBookings || analytics.recentBookings.length === 0) {
          adminBookingsBody.innerHTML = `<tr><td colspan="4" class="meta">No recent bookings</td></tr>`;
          return;
        }
        adminBookingsBody.innerHTML = analytics.recentBookings.map(booking => `
          <tr>
            <td>${booking.userName}</td>
            <td>${booking.carName}</td>
            <td>${new Date(booking.startDate).toLocaleDateString()} ‚Äì ${new Date(booking.endDate).toLocaleDateString()}</td>
            <td>‚Ç¶${booking.amount.toLocaleString()}</td>
          </tr>
        `).join('');
      } catch {
        adminBookingsBody.innerHTML = `<tr><td colspan="4" class="meta">Failed to load admin analytics</td></tr>`;
      }
    }

    logoutBtn.addEventListener('click', () => {
      localStorage.removeItem('token');
      window.location.href = 'login.html';
    });

    (async function initDashboard() {
      await fetchUserProfile();
      await fetchUserStats();
      await fetchRentalHistory();
      renderAllPreviews();
    })();
  </script>
</body>
</html>
